---
title: ' [!DNL Wireshark] を使用した SMPP プロトコルの分析'
description: 説明
solution: Campaign
product: Campaign
applies-to: Campaign Classic
keywords: KCS, SMPP, Wireshark
resolution: Resolution
internal-notes: null
bug: false
article-created-by: Craig Thonis
article-created-date: 5/6/2022 3:51:03 PM
article-published-by: Craig Thonis
article-published-date: 5/6/2022 3:52:19 PM
version-number: 4
article-number: KA-17506
dynamics-url: https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=9319e64e-54cd-ec11-a7b5-6045bd00d4f5
exl-id: 39c89da2-36ae-4c66-9553-cfc3d5b4003a
source-git-commit: 0c3e421beca46d9fe1952b1f98538a50697216a0
workflow-type: tm+mt
source-wordcount: '2415'
ht-degree: 100%

---

# [!DNL Wireshark] を使用した SMPP プロトコルの分析

## 説明

<br>[!DNL Wireshark] を使用した SMPP トラフィックの分析について説明します。<br><br><br><br><br>はじめに<br><br><br><br> <br><br>
ほとんどのスループット SMS-C は、SMPP プロトコルバージョン 3.4 と互換性があります。このプロトコルを使用すると、SMS を送信したり、その SMS の配信に関する情報を受信したりできます。SMPP プロトコルは、SMPP プロトコル仕様 v3.4 に記載されており、インターネット上で PDF 文書として入手できます。

この記事は、この仕様の代わりとなるものではありません。Adobe Campaign と SMS-C パートナーの間の問題のトラブルシューティングを支援するために、プロトコル仕様を解釈し、[!DNL Wireshark] の表示と照合する方法について、実践的なヒントを提供するものです。

SMPP プロトコルは、実装チームの解釈に委ねられる部分が多いので、SMS-C ごとに違いがあります。

トラブルシューティングの際には、常に SMS-C パートナーに問い合わせて、情報を得たり、得られた情報を再確認したりするようにしてください。SMS-C からエラーが返ってきた場合、そのようなエラーが返ってきた理由を伝えることができるのは、SMS-C パートナーです。実際の SMS-C に接続するのではなく、SMPP シミュレーターを使用している場合は、ソースコード（またはデバッガー）を使用して何が起こっているのかを把握する必要があります。


## 解決策

<br><br>Wireshark を使用せずにネットワークトラフィックをキャプチャする[!DNL Wireshark]<br><br><br><br><br><br>
マシンに直接アクセスできない場合は、*tcpdump* のようなコマンドラインツールを使用してキャプチャすることが必要な場合があります。接続の TCP ポートが既にわかっている場合は、すべてのトラフィックをキャプチャしないように、正しいフィルターを設定します。次に、ポート `12345` を <b>`outfile.pcap`</b> にキャプチャするための `tcpdump` コマンドラインの例を示します。


| `tcpdump -i any -w outfile.pcap tcp port 12345` |
| --- |


ファイル <b>`outfile.pcap`</b> は [!DNL Wireshark] で開いて、さらに分析できます。


<br><br>[!DNL Wireshark] 処理<br><br><br><br> <br><br><br><br>
このトピックは、[!DNL Wireshark] の基本（パケットのキャプチャ、簡単なフィルターの定義、パケットの詳細の読み取り）に精通していることを前提にしています。簡単な紹介については、[howtogeek - How to Use [!DNL Wireshark] to Capture, Filter, and Inspect Packets](https://www.howtogeek.com/104278/how-to-use-wireshark-to-capture-filter-and-inspect-packets/)（Wireshark を使用したパケットのキャプチャ、フィルタリング、検査方法）を参照してください。

[!DNL Wireshark] で SMPP トラフィックをフィルタリングするには、次の 3 つの重要な機能があります。

- SMS-C のポートに表示フィルターを使用します。
例えば、SMS-C がポート `10000` を使用している場合、次のフィルターを使用します。
   *`tcp.port == 10000`*


電話番号やテキストの内容でパケットを分離するには、次の設定で検索機能を使用します。
![smpp1](https://helpx.adobe.com/content/dam/help/en/campaign/kb/smpp-protocol-wireshark/jcr_content/main-pars/image/smpp1.png "smpp1")
- <b>TCP ストリームに従う</b>ツールを使用して、作業中のストリームを分離します。
ポップアップする赤／青のテキストウィンドウは、SMPP とは関係のないテキストプロトコルににのみ有用なので、閉じてください。
   ![smpp2](https://helpx.adobe.com/content/dam/help/en/campaign/kb/smpp-protocol-wireshark/jcr_content/main-pars/image_964579199/smpp2.png "smpp2")



<br><br><br><br>SMPP プロトコル<br><br> <br><br>
このプロトコルは、TCP 上で動作し、完全なバイナリなので、ストリームのコンテンツを復号化するには、[!DNL Wireshark]（または 16 進エディター）のような特別なツールが必要です。

ストリームは、独立した PDU で構成されており、各 PDU は、コマンド、ステータス、シーケンス番号およびコマンドに基づくその他の情報を含むメッセージです。

ストリームプロトコルとしての TCP の性質上、TCP パケットには複数の PDU が含まれることがあり、PDU は 2 つ以上の TCP パケットにまたがることがあります。[!DNL Wireshark] は PDU を正しく再アセンブルするので、[!DNL Wireshark] ユーザーにとっては、ほとんど透過的です。

次に、MT を送信してから SR を受信する際に、ネットワークを通過する PDU の例を示します。
![smpp3](https://helpx.adobe.com/content/dam/help/en/campaign/kb/smpp-protocol-wireshark/jcr_content/main-pars/image_388497282/smpp3.png "smpp3")
メモ：

標準コマンドのリストは、SMPP 仕様 5.1.2.1 節（SMPP コマンドセット）に記載されています。
<br><br><br><br><br><br>SMPP 応答<br><br><br><br> <br><br>
SMPP プロトコルでは、すべてのコマンドが応答 PDU によって確認される必要があります。

`BIND_TRANSMITTER` は、*`BIND_TRANSMITTER_RESP`* によって確認され、*`SUBMIT_SM`* は、*`SUBMIT_SM_RESP`* によって確認される、などです。

応答にはタイムアウトがあり、通常、10、30 または 60 秒です。応答は、肯定的な受信確認（`command _status = 0`）またはエラー（標準エラーのリストについては、SMPP 仕様の&#x200B;*表 5-2* の 5.1.3 *`command_status`* を参照）を含めることができます。ほとんどの場合、これらの応答は即座に行われ、応答タイムアウトに到達することはありません。

SMPP 応答エラーと SR エラーコードを必ず区別してください。同じエラーコードでも、応答エラーと SR エラーフィールドでは、異なる意味を持つことがあります。エラーコードをレポートする場合、値の意味はそのコンテキストに依存するので、どこでそれを見つけたかについて十分に注意する必要があります。
<br><br><br><br><br><br>SMPP 接続の初期化<br><br><br><br><br><br>
SMPP 接続は、TCP を使用して接続することから始まります。次に `BIND` 操作が [!DNL Campaign] によって送信され、`BIND RESP` によって確認されます。これらの操作は、SMPP 仕様の 4.1 節（`BIND` 操作）で説明されています。
![smpp4](https://helpx.adobe.com/content/dam/help/en/campaign/kb/smpp-protocol-wireshark/jcr_content/main-pars/image_468626174/smpp4.png "smpp4")
bind 操作では、ログイン／パスワードのチェックと、プラットフォーム名、バージョン、仕様に記載されているその他のフィールドの情報を交換します。

メモ：

ログインは、`system_id` フィールドにあります。



[!DNL Campaign] では、MT 転送を開始する際に *`BIND_TRANSMITTER`* パケットを確認し、*`nlsm s`* が MO／SR 接続をトリガーする際に *`BIND_RECEIVER`* パケットを確認する必要があります。

<b>トランスミッター、レシーバーおよびトランシーバー：</b>Campaign Classic 用 SMPP コネクタは、別のトランスミッター／レシーバーモードで動作します（MT の送信用と MO および SR の受信用の 2 つの TCP 接続があります）。レシーバーモードであっても、TCP 接続は、常に [!DNL Campaign] によって開始されることに注意してください。

SMPP にはトランシーバーモードもありますが、Campaign Classic の SMPP コネクタには、このモードは実装されていません。

SMPP コネクタは、複数の接続を並行して使用して MT を送信します。これは、コネクタの設計上、制御できません。
<br><br><br><br><br><br>MO の受信<br><br><br><br><br><br>
レシーバーがバインドされている場合、SMS-C はいつでも MO を送信できます。MO は、*`esm_clas s`* のビット 2 ～ 5 をクリアした *`DELIVER_SM`* PDU を使用して送信されます（多くの場合、*`esm_class`* は単に 0 になる）。
![smpp5](https://helpx.adobe.com/content/dam/help/en/campaign/kb/smpp-protocol-wireshark/jcr_content/main-pars/image_695769115/smpp5.png "smpp5")
*`DELIVER_SM`* PDU は、同じ *`sequence_number`* を持つ *`DELIVER_SM_RESP`* PDU ですばやく返信する必要があります。
<br><br><br><br><br><br>MT の送信<br><br><br><br><br><br>
MT を送信するには、トランスミッターが正常にバインドされている必要があります。何よりも先に、バインド処理が正常に実行されたことを確認してください。

MT は、*`SUBMIT_SM`* PDU で送信されます。SMS-C は、*`SUBMIT_SM_RESP`* PDU ですばやく返信します。この応答パケットは、SMS-C のデータベース内のメッセージの ID が含まれているので、特別です（SMS-C パートナーと話す際には、メッセージをよりすばやく見つけるために、常にこの ID を含めます）。この ID は、SR に含まれ、MT を対応する SR と照合させる唯一の方法です。

フィールド *`registered_delivery`*（仕様の 5.2.17 節に記載）は、この特定の MT に対して SR がリクエストされているかどうかを SMS-C に示します。特定のメッセージに対する SR を受信しない場合は、*`SUBMIT_SM`* PDU にこのフィールドが正しく設定されていることを確認します。
![smpp5](https://helpx.adobe.com/content/dam/help/en/campaign/kb/smpp-protocol-wireshark/jcr_content/main-pars/image_1891077095/smpp5.png "smpp5")<br><br><br><br><br><br>MT のエンコーディング<br><br><br><br><br><br>
注意：

SMS エンコーディングは、多くの落とし穴があり、様々な実装がある複雑なテーマです。


<br><br><br><br> <br><br>
エンコーディングの問題が発生した場合は、常に SMS-C パートナーに問い合わせることをお勧めします。SMS パートナーは、サポートされているエンコーディングと、技術的なプラットフォームの制限によって適用される可能性のある特別なルールについて、正確な知識を持っています。あなたから SMS-C パートナーに送信し、SMS-C パートナーがあなたに送り返すものを SMS-C パートナーにチェックさせることが、相互接続を成功させ、安定させるための唯一の方法です。

SMS メッセージは、特殊な 7 ビットエンコーディングを使用します。通常、GSM7 エンコーディングと呼ばれます。[!DNL Wikipedia] GSM 03.38（英語）を参照してください。
<br><br><br><br> <br><br>
SMPP プロトコルでは、トラブルシューティングを容易にするために、GSM7 のテキストが 1 文字あたり 8 ビットに拡張されます。SMS-C は、携帯電話に送信される前に、1 文字あたり 7 ビットにパックします。つまり、SMS の short_message フィールドの長さは SMPP フレームで最大 160 バイトになりますが、モバイルネットワークで送信される場合は 140 バイトに制限されます（最上位ビットは単に廃棄されます）。

エンコードの問題が発生した場合は、次の点を確認してください。

- 最初に、どの文字がどのエンコーディングに属するのかを把握しておくようにします。GSM7 は、発音区別符号（アクセント）を部分的にサポートしていることで悪名高いです。フランス語の場合、é と è が GSM7 に含まれますが、ê、â、ï は含まれません。スペイン語に関しても、状況は良くありません。
- セディーユ付きの C（ç）は、GSM7 アルファベットでは大文字のみ存在しますが、一部の機種では小文字または「スマート」文字で表示されます。一般的には、これを完全に避けてセディーユを削除する（フランス語ではそれでも非常に読みやすい）か、UCS-2 に切り替えることをお勧めします。
- SMS-C パートナーから明示的にリクエストされない限り、SMS で ASCII を使用しないでください。このエンコーディングは、8 ビット文字で、GSM7 よりカバー範囲が狭いので、容量を浪費します。
- Latin-1 は、常にサポートされているわけではありません。Latin-1 の使用を試みる前に、SMS-C パートナーに互換性を確認してください。
- 各国語シフトテーブルは、Adobe Campaign Classic コネクタではサポートされていません。代わりに UCS-2 を使用する必要があります。
- UCS-2 と UTF-16 は、多くの場合、携帯電話で混在します。これは、絵文字や UCS-2 には存在しない、めったに使われない文字を送信するユーザーにとっては問題です。
- GSM7 エンコーディングは、[!DNL Wireshark] ではサポートされていません。間違って特殊文字が表示されます。GSM7 文字列が適切にエンコードされているかどうかを確認する必要がある場合は、16 進コードと GSM7 テーブルを比較する必要があります。


*`data_coding`* フィールドは、使用されるエンコーディングを示します。唯一の問題は、値 0 は、仕様ではデフォルト SMS-C エンコーディングを意味しますが、一般的には GSM7 を意味することです。`data_coding = 0` に関連するエンコーディングを SMS-C *パートナーに確認してください（Adobe Campaign は、`data_coding* = 0` に対してのみ GSM7 をサポートします）。

メッセージの最大サイズは、エンコーディングによって異なります。次の表に、すべての関連情報をまとめます。
<br><br><br><br> <br>

| エンコード | data_coding | メッセージサイズ（文字） | マルチパート SMS のパーツサイズ  | 使用可能な文字  |
| --- | --- | --- | --- | --- |
| GSM7 | 0 | 160 | 152 | [GSM7 基本文字セット + 拡張文字](https://en.wikipedia.org/wiki/GSM_03.38)（拡張文字は 2 文字） |
| Latin-1  | 3 | 140 | 134 | ISO-8859-1 |
| UCS-2 UTF-16  | 8 | 70 | 67 | Unicode（携帯電話によって異なります） |

<br><br><br><br><br>ユーザーデータヘッダー（UDH）<br><br><br><br><br><br>
UDH（ユーザーデータヘッダー）は、SMS のテキストに追加される小さなバイナリヘッダーです。これにより、SMS 連結、各国語シフトテーブル、ロゴ／画像（ほとんど使用されない）、WAP プッシュなどの特別な機能をトリガーできます。

UDH はテキストフィールド（short_message SMPP フィールド）の一部なので、SMS の有効サイズを短くすることができます。例えば、連結された SMS UDH は、SMS パートあたり 6 バイト（7 ビット文字ではなく、実際の 8 ビットの 6 バイト）を消費し、メッセージパートあたり 152 個の 7 ビット文字のみが入る十分なスペースが残ります。

[!DNL Wikipedia] には、ユーザーデータヘッダーおよび連結された SMS に関する優れた記事があります（英語）。

short_message に UDH が含まれているかどうかを把握するには、esm_class の 6 ビットと 7 ビットを確認します（仕様の 5.2.12 節を参照）。[!DNL Wireshark] は、インターフェイスの UDH を解析して、正確な情報を提供します。
![smpp7](https://helpx.adobe.com/content/dam/help/en/campaign/kb/smpp-protocol-wireshark/jcr_content/main-pars/image_738682084/smpp7.png "smpp7")
このスクリーンショットには、メッセージフィールドのユーザーデータヘッダー（1）、UDH に含まれる情報（2）、パケットに属さないが [!DNL Wireshark] によって計算されたいくつかの追加情報（3）が確認できます。ショートメッセージ本文フィールドは、[!DNL Wireshark] によって再構築された完全なメッセージを含むので、特に興味深いものです。
<br><br><br><br><br><br>SR の受信<br><br><br><br><br><br>
レシーバーがバインドされている場合、SMS-C はいつでも SR を送信できます。SR は、*`esm_class`* のビット 2 ～ 5 を設定した DELIVER_SM PDU を使用して送信されます。
![smpp8](https://helpx.adobe.com/content/dam/help/en/campaign/kb/smpp-protocol-wireshark/jcr_content/main-pars/image_158644074/smpp8.png "smpp8")
*`DELIVER_SM`* PDU は、同じ *`sequence_number`* を持つ *`DELIVER_SM_RESP`* PDU ですばやく返信する必要があります。この SR に一致する MT を見つけるには、同じ ID の *`SUBMIT_SM_RESP`* を検索します。例えば、これが SR に一致する MT です。
![smpp9](https://helpx.adobe.com/content/dam/help/en/campaign/kb/smpp-protocol-wireshark/jcr_content/main-pars/image_1012110897/smpp9.png "smpp9")
SR は、MT に *`registered_delivery`* フィールドが設定されている場合にのみ送信されます。

メモ：

Adobe Campaign Classic SMPP コネクタは、*`SUBMIT_SM_RESP`* パケットの前に到着した SR を処理しません。仕様では、この動作を明示的に禁止してはいませんが、悪い動作と見なされます（メッセージが送信される前に受信されたことになります）。この事例に頻繁に遭遇する場合、SMS-C パートナーにプラットフォームを修正するように依頼してください。
<br><br><br><br><br><br>SR の short_message フィールドの解読<br><br><br><br><br><br>
SR PDU のテキストフィールドには、SMPP プロトコル仕様の付録 B に記載されている特別なエンコーディングが備わっています。残念ながら、ほとんどの SMS-C が多かれ少なかれこの形式を尊重しているにもかかわらず、この形式はプロトコルの一部ではなく、単なる推奨事項です。

SMS-C パートナーに直接、その独自の実装のドキュメントを要求し、それが [!DNL Wireshark] で見たものと一致しているかどうかをダブルチェックする必要があります。大抵の場合、SMS-C の実装者が自分の実装を把握しておらず、これが問題や誤解につながっています。このフィールド（特にエラーコード）について疑問がある場合は、遠慮なく SMS-C パートナーにお問い合わせください。

基本的な形式を次に示します。

*`id:IIIIIIIIII sub:SSS dlvrd:DDD submit date:YYMMDDhhmm done date:YYMMDDhhmm stat:DDDDDDD err:EEE`*

*`Text:........`*

次に、上記の行の読み方の一般的なガイドラインを示します。

- ID は、一致する MT の *`SUBMIT_SM_RESP`* で送信したものと同じです。
- `text` フィールドの問題は、無視できます。このフィールドは、SMS が純粋な英数字の ASCII とは別のエンコーディングを使用して送信された場合、役に立たない、信頼できない、さらには完全に読めない可能性があるので、[!DNL Campaign] では無視されます。これは正常な動作です。
- フィールド名では、大文字と小文字が区別されません（例えば、`id`: `sub`: `Text`: は、`ID`: `SUB`: `text`: を記述することもできます）。
- *`dlvrd`*フィールドは、SMS-C パートナーによってドキュメント化されていない限り、通常、信頼性がありません。
- 日付は、どのタイムゾーンにも属す可能性があり、実質的に役に立たないか、またはリモートサーバーの時計がオフになっているので、単純に間違っている可能性があります。
- *`stat`* フィールドは、付録 B で定義されている以外の値を持つ可能性があります。常識的な判断と SMS-C パートナーのドキュメントを使用して、その意味を把握するようにします。
- *`err`* フィールドは、完全に SMS-C に依存し、ほとんどの場合、SMS-C パートナーによってドキュメント化されます。多くの場合、コード 000 は成功を意味し、それ以外のコードはエラーを示します。このフィールドは、多くの場合、数値ですが、16 進数であることもあります。

<br><br><br><br><br><br>同じ MT に対する複数の SR<br><br><br><br><br><br>
一部の SMS-C は、同じ MT に対して複数の SR を送信し、ネットワークでの MT の進行を追跡します。大抵の場合、クライアントは、いつメッセージを受け取ったかのみを把握したい（これは、通常、最後の SR）ので、これは、ほとんど役に立ちません。

疑わしい場合は、SMS-C から受信した最新の SR のみを処理してメッセージの状態を確認します。.
<br><br><br><br><br><br>SMPP ウィンドウ<br><br><br><br><br><br>
操作と応答は非同期なので、応答を待機する前に複数の操作 PDU を送信することで、転送レートを最適化できます。返信がないメッセージの数は、ウィンドウと呼ばれます。

最大ウィンドウが 4 の送信の例：
![smpp10](https://helpx.adobe.com/content/dam/help/en/campaign/kb/smpp-protocol-wireshark/jcr_content/main-pars/image_2072040949/smpp10.png "smpp10")
現在の実装では、ウィンドウを制御せず、MT を処理するのに十分な速度をリモート SMS-C が持っていることが期待されています。
