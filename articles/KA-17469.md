---
title: "BlobId 用の InputStream の取得中にデータストア不整合エラーが発生しました"
description: 説明
solution: Experience Manager
product: Experience Manager
applies-to: "Experience Manager 6.4,Experience Manager 6.5"
keywords: "KCS"
resolution: Resolution
internal-notes: null
bug: false
article-created-by: Roxann McGlumphy
article-created-date: "10/20/2021 11:02:09 PM"
article-published-by: Roxann McGlumphy
article-published-date: "10/20/2021 11:05:09 PM"
version-number: 1
article-number: KA-17469
dynamics-url: "https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=74345cbc-f931-ec11-b6e5-000d3a5ba97a"
exl-id: fc7815f6-edb3-4166-a374-0f9799823af7
source-git-commit: 0c3e421beca46d9fe1952b1f98538a50697216a0
workflow-type: tm+mt
source-wordcount: '858'
ht-degree: 2%

---

# 「blobId 用の InputStream」の取得中にデータストアの不整合エラーが発生しました

## 説明

<br><br><br>問題：&quot;blobId の InputStream の取得中にエラーが発生しました&quot;<br><br><br><br><br><br>
次の条件を満たしている： [FileDataStore](https://docs.adobe.com/docs/en/aem/6-0/deploy/upgrade/data-store-config.html#Data%20Store%20Configurations) Adobe Experience Manager 6.x/Oak 1.x システムで、および `error.log` 「blobId の InputStream の取得中にエラーが発生しました」が表示されます。
<br><br><br><br><br> <br><br><br><br>

| 1<br>  2 | `10.09.2015 10:38:04.220 *ERROR* pool-9-thread-3 org.apache.sling.commons.scheduler.impl.QuartzScheduler Exception during job execution of org.apache.jackrabbit.oak.plugins.index.AsyncIndexUpdate@7fe7e8fa : Error occurred while obtaining InputStream for blobId add1dd8fc5093b27b1fae1b753cb48b24ef3231f#101983` `java.lang.RuntimeException: Error occurred while obtaining InputStream for blobId add1dd8fc5093b27b1fae1b753cb48b24ef3231f#101983` |
| --- | --- |



## 解像度


このエラーは、Adobe Experience Managerデータストアディレクトリにファイルが存在しない可能性があることを意味します。  Oak Blob ガベージコレクションの失敗、ディスク領域の停止、ディスク、またはネットワーク共有の不安定性が原因で、データストアファイルが失われる可能性があります。  または、ユーザーが誤ってサーバーからファイルを削除したことが原因である可能性があります。

見つからないファイルを回復するには、次の手順に従います。
<br><br><br><br> <br><br>1. 最新の CFP/SP のインストール<br><br><br><br> <br><br>
最新のホットフィックスは、 [Adobeパッケージ共有](https://www.adobeaemcloud.com/content/packageshare.html).
<br><br><br><br> <br><br>2. データストアの整合性チェックを実行<br><br><br><br> <br><br>
使用 `oak-run` jar 1.6.6 以降で、次のコマンドを実行します。

<b>java -jar oak-run-\*.jar datastorecheck —consistency -ref —id —fds crx-quickstart/install/org.apache.jackrabbit.oak.plugins.blob.datastore.FileDataStore.config —repoHome crx-quickstart/repository —store crx-quickstart/repository/datastore —temp —verbose —trobse</b>
<br><br><br><br> <br><br>3. 見つからないファイルのパスのリストを作成する<br><br><br><br> <br><br>
見つからないファイルを復元する次の手順は、見つからないファイルのパスの完全なリストをコンパイルすることです。

1. 「Record not Found」というエラーが発生した場合は、一貫性チェックの出力を検索します。

a. <b>In [!DNL Linux] または [!DNL Unix]:</b> このコマンドを使用して、見つからないファイルのリストをファイルに出力します *missing_ds_files.txt*:
<br><br><br><br><br> <br><br><br><br>

| `grep` `"blobId"` `consistency_check_output.txt | ` `grep` `-Eo ` `"0-9a-f{40,200}"` `| ` `awk` `'{ print substr($1, 0,2) "/" substr($1, 3,2) "/" substr($1, 5,2) "/" $1 }'` `| ` `sort` `-u  missing_ds_files.txt` |
| --- |

<br><br><br><br><br> <br><br>
\*\* 「blobId」エラーが原因でAdobe Experience Managerインスタンスが起動しない場合は、以下のログファイルを検索してください。 `crx-quickstart/logs` を返します。
<br><br><br><br><br> <br><br><br><br>

| `grep` `"Error occurred while obtaining InputStream for blobId"` `error.log* | ` `grep` `-Eo ` `"0-9a-f{40,200}"` `| ` `awk` `'{ print substr($1, 0,2) "/" substr($1, 3,2) "/" substr($1, 5,2) "/" $1 }'` `| ` `sort` `-u  missing_ds_files.txt` |
| --- |

<br><br><br><br><br> <br><br>
コマンドが正しく動作している場合、 `missing_ds_files.txt` 次のようになります。
<br><br><br><br><br> <br><br><br><br>

| `12/92/04/129204a6dd0ce2cd5ca19c721b6f52ee2b3630e2` `9f/d8/38/9fd8386d20cf55e7e0024e18d0c7d4e8400454ee` `7a/13/15/7a1315788f45dafd6630454f04183601682a9f80` `28/37/d2/2837d24aed3ff223cd40e90222226c4ef2e2a0c6` |
| --- |

<br><br><br><br><br> <br><br>
b. <b>In [!DNL Windows]:</b>  次のようなテキストエディターを使用します。 [!DNL Textpad] または [!DNL Notepad++] 「レコードが見つかりません」という文字列をすべて検索する  次に、これらの箇所をすべて見つけたら、マクロを使用してファイル名を抽出し、スクリプトを記述するか、新しいテキストファイルにファイル名を手動でコピーして作成します。

DataStore ファイルのパスは、次の形式のレコード名から構築されます。
*`{first two chars of record id}/{second two chars of record id}/{third two chars of record id}/{record id}`*

例えば、次のエラーが発生します。
<br><br><br><br><br> <br><br><br><br>

| `java.lang.RuntimeException: Error occurred while obtaining InputStream for blobId add1dd8fc5093b27b1fae1b753cb48b24ef3231f#101983` |
| --- |

<br><br><br><br><br> <br><br>
レコード id は `add1dd8fc5093b27b1fae1b753cb48b24ef3231f` ファイルパスは `ad*/d1/dd/add1dd8fc5093b27b1fae1b753cb48b24ef3231f*`
<br><br><br><br> <br><br>4. 見つからないファイルを復元<br><br><br><br> <br><br>
次に、最後の手順の出力を使用して、環境内の他のAdobe Experience Managerインスタンス内の同じファイルを追跡します。  データストアファイルは一意に保存されるので、環境内の他のAdobe Experience Managerインスタンスからコピーできます。

他のインスタンスにファイルが見つからない場合は、バックアップを検索し、可能な場合はそこから復元します。

In [!DNL Linux]を使用すると、作業中の各Adobe Experience Managerインスタンスにログインし、 rsync のようなコマンドを使用して、存在しないファイルをコピーすることができます。  例えば、見つからないファイルを持つサーバー上の datastore ディレクトリからこのファイルを実行すると、次のようになります。
<br><br><br><br><br> <br><br><br><br>

| `rsync` `-avR --files-from=missing_ds_files.txt . user@` `hostname` `-of-server-missing-files:` `/path/to/crx-quickstart/repository/repository/datastore/` |
| --- |

<br><br><br><br><br> <br><br>
コマンドは、 `missing_ds_files.txt` サーバーに存在する
<br><br><br><br> <br><br>5. 回復不能なファイル参照をクリーンアップ<br><br><br><br> <br><br>
バックアップまたは他のAdobe Experience Managerインスタンスから一部のファイルを復元できなかった場合は、不正なデータストア参照をクリーンアップするか、修正します。  手順 4 で実行したとおりに、データストアの整合性チェックを再実行します。  見つからないファイルの現在のリストが表示されます。

見つからないデータストアファイルを参照している、リストに表示された各ノードパスを確認します。  見つからない DAM アセットや、ユーザーがページにアップロードしたファイルを確認します。  必要な、見つからないものを再アップロードしてもらいます。  不要な要素は、Adobe Experience Managerユーザーインターフェイスを使用して安全に削除できます。  の下に何かが見つからない場合 `/var/audit` または `/var/eventing` は安全に削除できます。  不明なファイルについては、 [ここ](https://helpx.adobe.com/jp/marketing-cloud/contact-support.html) サポートが必要な場合は、AEMサポートチームにお問い合わせください。
<br><br><br><br> <br><br>6. すべての非同期 Oak インデックスを再インデックス化<br><br><br><br> <br><br>
インデックスファイルは Oak リポジトリ内に保存されるので、一部のファイルが Oak リポジトリにない可能性もあります。 `/oak:index` lucene ベースのインデックス

見つからないファイルは、 `/system/console/repositorycheck` 整合性チェックは、リポジトリトラバーサルに表示されません。  残念ながら、このようなファイルは異なるAEMインスタンス間で一致しません。

このような不整合を修正するには、影響を受ける非同期 Oak インデックスを再インデックスします。

<b>警告：</b> この操作は非常に高価で、システム内のコンテンツの量に応じて、完了までに 10 分から複数日の長いダウンタイムが必要になります。

非同期インデックスを再インデックスするには：

1. ダウンロード `oak-run` Oak 環境にインストールしたバージョンと一致する 1.0.x: [https://repo1.maven.org/maven2/org/apache/jackrabbit/oak-run/](https://repo1.maven.org/maven2/org/apache/jackrabbit/oak-run/)

2. をアップロードします。 `oak-run` をAdobe Experience Managerサーバーに送信します。

3. すべてのAdobe Experience Managerインスタンスを停止します。

4. Adobe Experience Managerインスタンスの Oak ストレージに対応する以下のコマンドを実行します。

[!DNL TarMK] コマンド:
<br><br><br><br><br> <br><br><br><br>

| `java -Xmx4096m -jar /apps/staging/oak-run-*-*.jar checkpoints crx-quickstart/repository/segmentstore rm-all` |
| --- |

<br><br><br><br><br> <br><br>
[!DNL MongoMK] コマンド：
<br><br><br><br><br> <br><br><br><br>

| 1 | `java -Xmx4096m -jar oak-run-*-*.jar checkpoints mongodb://localhost/aem-author rm-all` |
| --- | --- |

<br><br><br><br><br> <br><br>
5. Adobe Experience Managerを再起動し、ログファイルで INFO ログメッセージを監視します。 `org.apache.jackrabbit.oak.plugins.index`.  インデックス作成の詳細を確認する場合は、に移動します。 `/system/console/slinglog` の UI とデバッグレベルログの有効化 `org.apache.jackrabbit.oak.plugins.index`.

次のようなログメッセージが表示されます。
<br><br><br><br><br> <br><br><br><br>

| `23.06.2015 14:26:23.070 *INFO* FelixStartLevel org.apache.jackrabbit.oak.plugins.index.IndexUpdate Reindexing will be performed for following indexes: /oak:index/cqAcUUID, /oak:index/nodetype, /oak:index/deviceIdentificationMode, /oak:index/campaignpath, /oak:index/active, /oak:index/jcrFrozenMixinTypes`<br>   <br>  `23.06.2015 14:26:23.517 *INFO* FelixStartLevel org.apache.jackrabbit.oak.plugins.index.IndexUpdate Reindexing Traversed #10000 /jcr:system/jcr:versionStorage/c8/5f` `...` `23.06.2015 14:28:51.999 *INFO* pool-8-thread-1 org.apache.jackrabbit.oak.plugins.index.IndexUpdate Indexing report` `    ` `- /oak:index/counter*(708)` `    ` `- /oak:index/authorizables*(159)` `    ` `- /oak:index/cqPageLucene*(1913)` `    ` `- /oak:index/ntBaseLucene*(444)` `    ` `- /oak:index/cqTagLucene*(512)` `    ` `- /oak:index/workflowDataLucene*(116)` `...`<br>   <br>  `23.06.2015 14:28:52.009 *INFO* pool-8-thread-1 org.apache.jackrabbit.oak.plugins.index.AsyncIndexUpdate Reindexing (async) completed for indexes: /oak:index/counter*(708), /oak:index/authorizables*(159), /oak:index/cqPageLucene*(1913), /oak:index/ntBaseLucene*(444), /oak:index/cqTagLucene*(512), /oak:index/workflowDataLucene*(116) in 30.36 s` |
| --- |

<br><br><br><br><br> <br><br>
6.何らかの理由でインデックス作成に失敗した場合は、次のログメッセージを繰り返してループします。
<br><br><br><br><br> <br><br><br><br>

| `23.06.2015 14:26:23.070 *INFO* FelixStartLevel org.apache.jackrabbit.oak.plugins.index.IndexUpdate Reindexing will be performed for following indexes: /oak:index/cqAcUUID, /oak:index/nodetype, /oak:index/deviceIdentificationMode, /oak:index/campaignpath, /oak:index/active, /oak:index/jcrFrozenMixinTypes` |
| --- |

<br><br><br><br><br> <br>
