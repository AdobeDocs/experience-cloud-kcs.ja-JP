---
title: "JVM からスレッドダンプを取得する"
description: 説明
solution: Experience Manager
product: Experience Manager
applies-to: "Experience Manager"
keywords: "KCS"
resolution: Resolution
internal-notes: null
bug: false
article-created-by: Roxann McGlumphy
article-created-date: "10/20/2021 6:41:42 PM"
article-published-by: Roxann McGlumphy
article-published-date: "10/20/2021 6:48:01 PM"
version-number: 1
article-number: KA-17452
dynamics-url: "https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=2e54c459-d531-ec11-b6e5-000d3a5ba97a"
exl-id: 9ad0fefe-b974-45d9-95b6-4a90f691f0cb
source-git-commit: 0c3e421beca46d9fe1952b1f98538a50697216a0
workflow-type: tm+mt
source-wordcount: '1052'
ht-degree: 0%

---

# JVM からスレッドダンプを取得する

## 説明

<br><br><br>で JVM からスレッドダンプを取得する方法 [!DNL Linux]、UNIX または [!DNL Windows]?<br><br><br><br> <br><br>
スレッドダンプは、 [!DNL Java] 現在、 [!DNL Java Virtual Machine] (JVM)。

JVM からスレッドダンプを取得する方法はいくつかあります。 1 つ以上のスレッドダンプを取ることを強くお勧めします。 通常は、一定の間隔で 10 個のスレッドダンプを取ることをお勧めします（たとえば、10 秒ごとに 1 個のスレッドダンプ）。


## 解像度

<br><br>手順 1:の PID を取得します [!DNL Java] プロセス<br><br><br><br> <br><br>
スレッドダンプを取得するために必要な最初の情報は、 [!DNL Java] プロセスの PID。

この [!DNL Java] JDK には jps コマンドが付属し、すべての [!DNL Java] プロセス id。 次のように、このコマンドを実行できます。


```
jps -l 70660 sun.tools.jps.Jps 70305
```


<b>注意：</b> In [!DNL Linux] UNIX の場合、次のようにしてこのコマンドを実行する必要があります。 `sudo -u user jps -l`(「user」は、 [!DNL Java] プロセスはとして実行されています。

これが機能しない場合、またはまだ [!DNL Java] プロセス、( パスが設定されていない、JDK がインストールされていない、または古い [!DNL Java] バージョン )、使用

- UNIX, [!DNL Linux]、およびMac OS X: `ps -el | grep java`
- [!DNL Windows]:Ctrl+Shift+Esc キーを押してタスクマネージャーを開き、 [!DNL Java] プロセス

<br><br><br><br><br><br>手順 2:JVM からのスレッドダンプのリクエスト<br><br><br><br><br><br><br><br>
<b>jstack</b>

インストール済み/利用可能な場合は、 <b>jstack</b> ツール コマンドラインコンソールにスレッドダンプを出力します。

jstack を使用してスレッドダンプを取得するには、次のコマンドを実行します。
`jstack -l pid`

コンソール出力 redirect/append ディレクティブを使用して、連続するスレッドダンプをファイルに出力できます。
`jstack -l pid  threaddumps.log`

注意：

- jstack ツールは、JDK 1.5（での JVM 用）以降で使用できます。 [!DNL Windows]（JDK 1.5 および JDK 1.6 の一部のバージョンでのみ使用可能）
- jstack は、 `-Xrs` jvm パラメーターが有効です
- JDK 1.6 の jstack ツールを使用して、JDK 1.5 で実行されているプロセスからスレッドダンプを取得することはできません。
- In [!DNL Linux] UNIX では、java プロセスを所有するユーザーとしてコマンドを実行する必要があります。

   `sudo -u *java-user* jstack -l *pid*`  

   (java-user は、 [!DNL Java] プロセスは次のように実行されています )
- In [!DNL Windows]を実行し、「このコマンドを処理するのに十分なストレージがない」というエラーが表示された場合は、jstack を windows SYSTEM ユーザーまたは java プロセスを所有するユーザーとして実行する必要があります。  これを行うには、ダウンロード可能な psexec を使用します [ここ](http://technet.microsoft.com/en-us/sysinternals/bb897553.aspx). jstack を SYSTEM ユーザーとして実行するには、次のようなコマンドを使用します。

   `psexec -s jstack *pid*   threaddumps.log`

   サーバに psexec をインストールできない場合は、コマンドを含む.bat ファイルを作成して実行できます [の使用 [!DNL Windows] タスクスケジューラ（別のユーザーとして）](https://technet.microsoft.com/en-us/library/cc748993%28v=ws.11%29.aspx).
- Java プロセスが応答しない場合は、オプションの使用に役立つことがあります <b>`-J-d64`</b> （64 ビットシステムの場合）次のようになります。

   `jstack -J-d64 -l *pid*  threaddumps.log`
- jstack コマンド (`jstack -l pid  threaddumps.log`) は以下のエラー 1 をスローし、java プロセスを所有するユーザーとしてコマンドを実行します。  例：

   `sudo -u sling jstack -l pid  threaddumps.log`



<br><br><br><br><br><br> <br><br><br><br>

```
Error attaching to process: sun.jvm.hotspot.debugger.DebuggerException: Can't attach to the process: ptrace(PTRACE_ATTACH, ..) failed for 22893: Operation not permitted

sun.jvm.hotspot.debugger.DebuggerException: sun.jvm.hotspot.debugger.DebuggerException: Can't attach to the process: ptrace(PTRACE_ATTACH, ..) failed for 22893: Operation not permitted

...

Caused by: sun.jvm.hotspot.debugger.DebuggerException: Can't attach to the process: ptrace(PTRACE_ATTACH, ..) failed for 22893: Operation not permitted

...

sun.jvm.hotspot.debugger.linux.LinuxDebuggerLocal$LinuxDebuggerLocalWorkerThread.run(LinuxDebuggerLocal.java:138)
```



<br><br>JSTACK スクリプト<br><br>
こちらが a です [スクリプト](https://github.com/cqsupport/jstackSeries.sh/blob/master/jstackSeries.sh) (～に適応したものから [eclipse.org](http://wiki.eclipse.org/How_to_report_a_deadlock#jstackSeries_--_jstack_sampling_in_fixed_time_intervals_.28tested_on_Linux.29)) は、jstack を使用して一連のスレッドダンプを取得します。  また、top コマンドを使用して、スレッドレベルの CPU 使用率も引き継ぎます。

次のように実行します。
`sudo -u *user*jstackSeries.sh *pid* *aemserveruser* *count* *delay*`

例：`sudo -u aemuser jstackSeries.sh 1234 aemserveruser 10 3`

- <b>1234</b> は、 [!DNL Java] プロセス
- <b>cq5serveruser</b> が [!DNL Linux] または UNIX ユーザー [!DNL Java] プロセス実行
- <b>10</b> は、取得するスレッドダンプの数です
- <b>3</b> は、各ダンプ間の遅延です


<b>注意： </b>最上位の出力では 10 進数形式のネイティブスレッド ID が使用され、jstack 出力では 16 進数の nid が使用されます。  スレッド ID を 16 進数に変換することで、最上位の出力から jstack 出力に高 cpu スレッドを一致させることができます。

上記のスクリプトに加えて、同様のスクリプトもあります [[!DNL Windows] PowerShell スクリプトと GitHub 上のAdobeAEM固有のスクリプト](https://github.com/cqsupport/jstackSeries.sh).

<b>Adobe Experience Managerのスレッドダンプツール</b>

Adobe Experience Manager製品を使用している場合は、 [このツール](https://helpx.adobe.com/experience-manager/kb/thread-dumps-collection-analysis.html) スレッドダンプを生成するためのシンプルな UI を持つ。
<br><br>スレッドダンプを取得する別の方法<br><br>
この <b>jstack</b> ツールを使用できない場合は、次のようにスレッドダンプを取得できます。

<b>注意：</b> 一部のツールは、コマンドラインパラメーターが `-Xrs` が有効になっている。 スレッドダンプの取得で問題が発生した場合は、このオプションが有効になっているかどうかを確認してください。
<br><br>UNIX、Mac OS X および [!DNL Linux] （JDK 1.4 以前のバージョン）<br><br>
UNIX、Mac OS X、 [!DNL Linux]に設定されている場合、QUIT シグナルを [!DNL Java] スレッドダンプを標準出力に出力するように指示するプロセス。

1. 次のコマンドを実行して、これを実行します。

   `kill -QUIT *pid*`

   このコマンドは、次のように実行する必要がある場合があります。 `sudo -u user kill -QUIT *pid*` ここで、「user」は、 [!DNL Java] プロセスはとして実行されています。
2. を使用して CQSE を起動する場合 `crx-quickstart/server/start` スクリプトを実行すると、スレッドダンプが `crx-quickstart/server/logs/startup.log`. JBoss などのサードパーティのアプリケーションサーバーを使用している場合、 [!DNL WebSphere], [!DNL Tomcat]またはその他の場合は、標準出力が送られるファイルを調べるには、サーバーのドキュメントを参照してください。

[!DNL Windows]:<br><br>JDK 1.X
1. javadump.exe をダウンロードします（下に添付）。
2. 次の 3 つの引数で JVM を起動します（正しい順序で指定する必要があります）。

   `-XX:+UnlockDiagnosticVMOptions -XX:+LogVMOutput -XX:LogFile=*C:\temp\jvmoutput.log*`
3. Ctrl+Shift+Esc キーを押して、タスクマネージャを開きます。
4. の PID を見つけます。 [!DNL Java] プロセス。
5. コマンドラインから、を実行します。

   `javadump.exe *pid*`
6. スレッドダンプが `jvmoutput.log` 手順 2 で説明したファイル

<br><br>JDK 1.6<br><br>
からスレッドダンプを取得する <b>jconsole</b> ツールを使用します。0

次に、スレッドダンプをリクエストする方法を示します。

1. 実行中の jvm に次のパラメーターを追加します。 `Communique` : `-Dcom.sun.management.jmxremote`
2. JDK 1.6 をダウンロードしてインストールします（まだ実行されていない場合）。
3. をダウンロードして抽出します。 [スレッドダンプアナライザユーティリティ](https://github.com/irockel/tda). 1
4. 実行 `jconsole.exe` JDK 1.6 の次のバージョン：

                               `jconsole.exe -pluginpath /path/to/file/tda.jar`
5. 次をクリック： <b>スレッドダンプ</b> タブをクリックします。
6. 次をクリック： <b>リクエストスレッドダンプ</b> リンク。

<b>注意：</b> AEM 6 を実行している場合。\*実行中のスレッドを監視するには、次を要求します。 `http://host:port/system/console/status-Threads` スレッドリストを取得します。 ただし、これらのスレッドダンプは samurai や tda などのスレッドダンプ分析ツールでは機能しません。<br><br>適用先<br><br>
JVM で実行されているすべてのAdobe製品
<br><br>スレッドダンプ分析ツール：<br><br>
0 [http://technet.microsoft.com/en-us/sysinternals/bb897553.aspx](http://technet.microsoft.com/en-us/sysinternals/bb897553.aspx)
1  [https://github.com/irockel/tda](https://github.com/irockel/tda)
2 [https://fastthread.io/](https://fastthread.io/)
3 [https://www.ibm.com/support/knowledgecenter/en/SSLLVC_5.0.0/com.ibm.esupport.tool.tmda.doc/docs/readme.htm](https://www.ibm.com/support/knowledgecenter/en/SSLLVC_5.0.0/com.ibm.esupport.tool.tmda.doc/docs/readme.htm)
