---
title: AEMインスタンス間でのユーザー、グループおよび ACL の移行
description: 説明
solution: Experience Manager
product: Experience Manager
applies-to: Experience Manager
keywords: KCS
resolution: Resolution
internal-notes: 'Helpx Link: https://helpx.adobe.com/experience-manager/kb/migrate-users-groups-ACLs.html ; Contains Docs links that may need to be changed'
bug: false
article-created-by: Gucci Paull
article-created-date: 6/21/2022 6:07:06 PM
article-published-by: Gucci Paull
article-published-date: 6/21/2022 6:07:59 PM
version-number: 8
article-number: KA-16448
dynamics-url: https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=d7ce3bf2-8cf1-ec11-bb3d-6045bd015716
exl-id: 5c285ad4-da35-4ee4-b3d1-3ac9eea5f5b2
source-git-commit: af761579c3fb5e51cf5f4d144bff0e058fd13911
workflow-type: tm+mt
source-wordcount: '960'
ht-degree: 2%

---

# AEMインスタンス間でのユーザー、グループおよび ACL の移行

## 説明

AEMで ACL 権限を持つユーザーとグループを、あるサーバーから別のサーバーに、またはあるAEMインスタンスから別のサーバーに移行する方法。

## 解像度

**手順 1:管理者ユーザーと匿名ユーザーの検索**

1. CRXDE Lite アプリに移動します。 `/crx/de/index.jsp` （ソースシステム上の）管理者ユーザーとしてログインします。
1. 「ツール」=「クエリ」に移動します。
1. 下部の「クエリ」ボックスで、次のクエリを入力して管理者ユーザーを検索します。 *`/jcr:root/home/users//element(\*,rep:User)@rep:principalName="admin" .`*
1. 「実行」をクリックし、結果に含まれる管理者ユーザーノードのパスをテキストファイルにコピーします。
1. 匿名ユーザーに対してクエリを使用して、手順 3 を繰り返します。 *`/jcr:root/home/users//element(\*,rep:User)@rep:principalName="anonymous" .`*
1. 「実行」をクリックし、結果内の匿名ユーザーノードのパスをテキストファイルにコピーします ( これで、2 つのパス（「admin」用と「anonymous」用）が作成されます )。

   例：

   `/home/users/Q/QY5FIMXeQIbGpwZtQ3Dv`  — ソース・システムの管理者ユーザー

   `/home/users/K/Kj1406Qo9IDODc_nk5Ib`  — ソース・システム上の匿名ユーザー

**手順 2A:ユーザーとグループの移行 ( `crx2oak` または `oak-upgrade`)**

ユーザーとグループは、 [crx2oak](https://helpx.adobe.com/experience-manager/6-4/sites/deploying/using/using-crx2oak.html) または [oak-upgrade](https://jackrabbit.apache.org/oak/docs/migration.html) ツール。

1. をダウンロードします。 `crx2oak` または `oak-upgrade` 使用している Oak バージョンと一致する jar: 
   1. Oak-upgrade: [https://repo1.maven.org/maven2/org/apache/jackrabbit/oak-upgrade](https://repo1.maven.org/maven2/org/apache/jackrabbit/oak-upgrade)
   1. Crx2Oak: [Maven リポジトリ](https://mvnrepository.com/artifact/com.adobe.granite/crx2oak?repo=adobe-public)
1. jar ファイルをAEMサーバーにアップロードします。
1. AEMを停止（ソースおよび宛先インスタンス）
1. 以下のコマンドの jar ファイルの名前を置き換えます。
1. 置換 *`/home/users/Q/QY5FIMXeQIbGpwZtQ3Dv,/home/users/K/Kj1406Qo9IDODc_nk5Ib`* 内 *`--exclude-paths`* 以下のコマンドの part パラメーターに、ソースシステムからの管理者ユーザーと匿名ユーザーのパスを指定します。
1. インスタンスに合わせて行上のパスを変更します ( *`segment-old:`* 必要に応じて、パスの前に次を表示します。 [https://jackrabbit.apache.org/oak/docs/migration.html](https://jackrabbit.apache.org/oak/docs/migration.html)): *`/opt/aem-source/crx-quickstart/repository /opt/aem-destination/crx-quickstart/repository`*
1. 次に、サーバーのシェルでコマンドを実行します。

   ```
   java -Xms2g -Xmx2g -jar oak-upgrade-1.8.12.jar \
   --include-paths=/home \
   --merge-paths=/home \
   --exclude-paths=/home/users/Q/QY5FIMXeQIbGpwZtQ3Dv,/home/users/K/Kj1406Qo9IDODc_nk5Ib,/home/groups/a/administrators,/home/groups/a/analytics-administrators,/home/groups/c/community-moderators,/home/groups/c/content-authors,/home/groups/c/contributor,/home/groups/community/community-groupadmin,/home/groups/community/community-sitecontentmanager,/home/groups/community/community-sitemembers,/home/groups/d/dam-users,/home/groups/default/order-administrators,/home/groups/e/everyone,/home/groups/f/forms-users,/home/groups/forms/fd-administrators,/home/groups/forms/forms-users,/home/groups/geometrixx,/home/groups/media,/home/groups/o/operators,/home/groups/projects,/home/groups/t/tag-administrators,/home/groups/t/target-activity-authors,/home/groups/u/user-administrators,/home/groups/w/workflow-editors,/home/groups/w/workflow-users,/home/users/a/admin,/home/users/a/anonymous,/home/users/mac,/home/users/media,/home/users/projects,/home/users/system,/home/rep:policy,/home/users/rep:policy,/home/groups/rep:policy \
   segment-old:/opt/aem-source/crx-quickstart/repository /opt/aem-destination/crx-quickstart/repository  upgradeusers.log &
   ```

1. 完了したら、手順 3 に進み、ACL を移行します。  を使用して移行できない場合 `crx2oak` その後、代わりに、以下のパッケージ移行手順に従ってください。

**手順 2B：ユーザーとグループを移行する（パッケージを使用）**

ユーザーが LDAP/SAML 認証を使用して自動的に読み込まれなかった場合、または `CRX2Oak` （上記の A のメソッドを参照）その後、ユーザーおよびグループをパッケージ化できます。  この場合、古いシステムに 2 つの個別のパッケージを作成します（管理者ユーザーと匿名の標準ユーザーを除く）。

1. 上記の手順 1 の結果（「管理者と匿名のユーザーを検索する」）から、匿名ユーザーノードと管理者ユーザーノードのパスをコピーします。

   例：

   `/home/users/Q/QY5FIMXeQIbGpwZtQ3Dv`  — パッケージを作成しているシステムの管理者ユーザー

   `/home/users/K/Kj1406Qo9IDODc_nk5Ib`  — パッケージを作成しているシステム上の匿名ユーザー

1. 「パッケージマネージャ」に移動します。 *`http://host:port/crx/packmgr/index.jsp`*&#x200B;をクリックし、管理者としてログインします。
1. パッケージ「users」を作成
1. パッケージ設定に次のフィルターを追加： `/home/users` 次の除外ルールを使用 ( `/home/users` フィルター ):
   1. `exclude /home/users/.\*/.tokens`
   1. `exclude /home/users/Q/QY5FIMXeQIbGpwZtQ3Dv`
   1. `exclude /home/users/K/Kj1406Qo9IDODc_nk5Ib`
   1. `exclude /home/users/a/admin`
   1. `exclude /home/users/a/anonymous`
   1. `exclude /home/users/system`
   1. `exclude /home/users/geometrixx`
   1. `exclude /home/users/media`
   1. `exclude /home/users/projects`
   1. `exclude /home/users/mac`
1. パッケージをビルドします。
1. パッケージをダウンロードします。
1. コンピューター上のパッケージ zip ファイルを解凍します。 `jar -xvf users.zip META-INF/vault/filter.xml`
1. ファイルを開きます。 `META-INF/vault/filter.xml` をクリックします。
1. 追加 `mode="merge"` をフィルター…タグに追加します。次に例を示します。

   ```
   ?xml version="1.0" encoding="UTF-8"?    workspaceFilter version="1.0"    filter root="/home/users" mode="merge"    exclude pattern="/home/users/.*/.tokens"/    exclude pattern="/home/users/Q/QY5FIMXeQIbGpwZtQ3Dv"/    exclude pattern="/home/users/K/Kj1406Qo9IDODc_nk5Ib"/    exclude pattern="/home/users/a/admin"/    exclude pattern="/home/users/a/anonymous"/    exclude pattern="/home/users/system"/    exclude pattern="/home/users/geometrixx"/    exclude pattern="/home/users/media"/    exclude pattern="/home/users/projects"/    exclude pattern="/home/users/mac"/    /filter    /workspaceFilter
   ```

1. 変更したパッケージの内容を再圧縮し、変更内容を含めます。

   ```
   jar -uvf users.zip META-INF/vault/filter.xml
   ```

1. フィルタールールを含む「グループ」パッケージを作成します `/home/groups`.
1. グループパッケージに対して、手順 11 ～ 14 を繰り返します。
1. （アップグレードのみ）新しいAEMバージョンへの移行を実行する場合は、新しいローカルAEMインスタンスをインストールします *古いバージョンの*（nosamplecontent を使用）、users パッケージをインストールし、そこに groups パッケージをインストールします。 次に、そのインスタンスで新しいバージョンへのインプレースアップグレードを実行します。 これにより、ユーザーが新しい Oak 表現に変換されます。 インプレースアップグレードの後、ユーザーを再度パッケージ化し、アップグレード対象のインスタンスに移植します。 ユーザーグループに対しても同じ操作を行います。
1. 新しいシステムにユーザーパッケージをインストールします。
1. 新しいシステムに groups パッケージをインストールします。
1. 古いAEMから 6.3 に移行する場合は、 `/useradmin` UI を開き、ユーザー replication-receiver を「administrators」グループに追加します。

**手順 3. ACL の移行**

ツール (ACS Commons) をAEMにインストールできる場合は、次の手順に従います。

1. ACS Commons をダウンロードしてインストールします。
1. ACL パッケージを作成するには、ここに示す手順に従います。
1. http://aem-host:port/crx/packmgr/index.jsp andに移動し、管理者としてログインします。
1. ACL パッケージをクリックします。
1. 「編集」をクリックします。
1. を選択します。 [!UICONTROL 詳細] タブ（下のスクリーンショットを参照）。
1. [AC の処理 ] ドロップダウンメニューで、 [!UICONTROL 結合] 宛先システム上の既存の ACL を削除しないようにします。 AEMの異なるバージョン間で ACL を移行する場合は（標準搭載の ACL を削除するのを防ぐ）、これが特に重要です。

次の場合、 *not* ツール (ACS Commons) をAEMにインストールするには、次の手順に従います。 これらのコマンドを実行するマシンは、Mac OS である必要があります。 [!DNL Linux]または [!DNL Windows] ( [!DNL Cygwin]) を cURL で [!DNL Python]、および [!DNL Java] SDK がインストールされました。

1. http://src-aem-host:port/crx/packmgr/index.jsp andに移動し、管理者としてログインします。
1. 「ACL-migration」という名前のパッケージを作成します。
1. 「編集」ボタンをクリックします。
1. を選択します。 [!UICONTROL 詳細] タブに移動し、 AC の処理モードを [ 結合 ] に設定します。
1. 保存します。
1. パッケージをビルドし、ダウンロードします。
1. ファイルシステム上で、パッケージに対して次のコマンドを実行し、 `META-INF/vault/filter.xml` ファイル： 

   ```
   jar -xvf ACL-migration-1.0.zip META-INF/vault/filter.xml
   ```

1. 同じディレクトリで、次のコマンドを実行して、の ACL パスの json ファイルをダウンロードします。 `/content` ソースインスタンスから（ユーザー名とパスワードを設定し、正しいホストを指定）、次の操作を実行します。 

   ```
   curl -u admin:admin 'http://aemhost/crx/de/query.jsp?' -G --data-urlencode '_dc=1507011481908&_charset_=utf-8&type=xpath&stmt=/jcr:root/content//element(*,rep:ACL)&showResults=true'  data.json
   ```

1. ファイルの作成 `generate-package-filter.py` をクリックし、 [!DNL Python] コードを以下に示します。 

   ```
   import json
   from pprint import pprint
   
   with open ('data.json') as data_file:
      data = json.load(data_file)
   
   print("?xml version=\"1.0\" encoding=\"UTF-8\"?")
   print("workspaceFilter version=\"1.0\"")
   
   for item in data "results":
       print("filter root=\"{path}\" /" . format(path=item "path"))
   
   print( "/workspaceFilter")
   ```

1. を実行します。 [!DNL Python] data.json が作成された同じフォルダーのスクリプトを使用して、出力を `META-INF/vault/filter.xml` ( `filter.xml`): 

   ```
   python generate-packge-filter.py  META-INF/vault/filter.xml
   ```

1. 次のコマンドを使用して、 `filter.xml` zip ファイル内で以下の手順を実行します。

   ```
   jar -uvf ACL-migration-1.0.zip META-INF/vault/filter.xml
   ```

1. zip ファイルをソースインスタンスパッケージマネージャー ( http://src-aem-host:port/crx/packmgr/index.jsp ) にアップロードします。
1. クリック [!UICONTROL ビルド] または [!UICONTROL 再構築] をクリックしてパッケージをビルドします。
1. ソースAEMサーバーからパッケージをダウンロードします。
1. パッケージを宛先のAEMサーバーのパッケージマネージャーにアップロードします ( http://dst-aem-host:port/crx/packmgr/index.jsp )。
1. クリック [!UICONTROL インストール] をクリックしてインストールします。
1. path curl コマンドを変更する他のパスに対して、手順 8～16 を繰り返します。 例えば、これにより、ACL が以下に取得されます。 `/etc` の代わりに `/content`:

   ```
   curl -u admin:admin 'http://aemhost/crx/de/query.jsp?' -G --data-urlencode '_dc=1507011481908&_charset_=utf-8&type=xpath&stmt=/jcr:root/etc//element(*,rep:ACL)&showResults=true'  data.json` |
   ```
