---
title: AEMインスタンス間でのユーザー、グループおよび ACL の移行
description: 説明
solution: Experience Manager
product: Experience Manager
applies-to: Experience Manager
keywords: KCS
resolution: Resolution
internal-notes: 'Helpx Link: https://helpx.adobe.com/experience-manager/kb/migrate-users-groups-ACLs.html ; Contains Docs links that may need to be changed'
bug: false
article-created-by: Gucci Paull
article-created-date: 6/21/2022 6:07:06 PM
article-published-by: Gucci Paull
article-published-date: 6/21/2022 6:07:59 PM
version-number: 8
article-number: KA-16448
dynamics-url: https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=d7ce3bf2-8cf1-ec11-bb3d-6045bd015716
exl-id: 5c285ad4-da35-4ee4-b3d1-3ac9eea5f5b2
source-git-commit: e8f4ca2dd578944d4fe399074fab461de88ad247
workflow-type: tm+mt
source-wordcount: '1132'
ht-degree: 2%

---

# AEMインスタンス間でのユーザー、グループおよび ACL の移行

## 説明


AEMで ACL 権限を持つユーザーとグループを、あるサーバーから別のサーバーに、またはあるAEMインスタンスから別のサーバーに移行する方法。


## 解像度


<b>手順 1:管理者ユーザーと匿名ユーザーの検索</b>

1. CRXDE lite アプリ/crx/de/index.jspに移動し、（ソースシステムで）管理者ユーザーとしてログインします。
2. 「ツール」=「クエリ」に移動します。
3. 下部の「クエリ」ボックスで、次のクエリを入力して管理者ユーザーを検索します。 */jcr:root/home/users//element(\*,rep:User)@rep:principalName=&quot;admin&quot;*
4. 「実行」をクリックし、結果に含まれる管理者ユーザーノードのパスをテキストファイルにコピーします。
5. 匿名ユーザーに対してクエリを使用して、手順 3 を繰り返します。 */jcr:root/home/users//element(\*,rep:User)@rep:principalName=&quot;anonymous&quot; 。*
6. 「実行」をクリックし、結果内の匿名ユーザーノードのパスをテキストファイルにコピーします ( これで、2 つのパス（「admin」用と「anonymous」用）が作成されます )。



   例：

   /home/users/Q/QY5FIMXeQIbGpwZtQ3Dv — ソースシステム上の管理者ユーザー

   /home/users/K/Kj1406Qo9IDODc_nk5Ib — ソースシステム上の匿名ユーザー


<b>手順 2A:ユーザーとグループの移行（crx2oak または oak-upgrade を使用）</b>

ユーザーとグループは、 [crx2oak](https://helpx.adobe.com/experience-manager/6-4/sites/deploying/using/using-crx2oak.html) または [oak-upgrade](https://jackrabbit.apache.org/oak/docs/migration.html) ツール。

1. 使用している Oak バージョンと一致する crx2oak または oak-upgrade jar をダウンロードします。 
   1. Oak-upgrade: [https://repo1.maven.org/maven2/org/apache/jackrabbit/oak-upgrade](https://repo1.maven.org/maven2/org/apache/jackrabbit/oak-upgrade)
   2. Crx2Oak: [Maven リポジトリ](https://mvnrepository.com/artifact/com.adobe.granite/crx2oak?repo=adobe-public)
2. jar ファイルをAEMサーバーにアップロードします。
3. AEMを停止（ソースおよび宛先インスタンス）
4. 以下のコマンドの jar ファイルの名前を置き換えます。
5. 置換 */home/users/Q/QY5FIMXeQIbGpwZtQ3Dv,/home/users/K/Kj1406Qo9IDODc_nk5Ib* 内 *—exclude-paths* 以下のコマンドの part パラメーターに、ソースシステムからの管理者ユーザーと匿名ユーザーのパスを指定します。
6. インスタンスに合わせて行上のパスを変更します ( *segment-old:* 必要に応じて、パスの前に次を表示します。 [https://jackrabbit.apache.org/oak/docs/migration.html](https://jackrabbit.apache.org/oak/docs/migration.html)): */opt/aem-source/crx-quickstart/repository /opt/aem-destination/crx-quickstart/repository*
7. 次に、サーバーのシェルでコマンドを実行します。     `java -Xms2g -Xmx2g -jar oak-upgrade-1.8.12.jar \`

   `--include-paths=/home \`
   `--merge-paths=/home \`
   `--exclude-paths=/home/users/Q/QY5FIMXeQIbGpwZtQ3Dv,/home/users/K/Kj1406Qo9IDODc_nk5Ib,/home/groups/a/administrators,/home/groups/a/analytics-administrators,/home/groups/c/community-moderators,/home/groups/c/content-authors,/home/groups/c/contributor,/home/groups/community/community-groupadmin,/home/groups/community/community-sitecontentmanager,/home/groups/community/community-sitemembers,/home/groups/d/dam-users,/home/groups/default/order-administrators,/home/groups/e/everyone,/home/groups/f/forms-users,/home/groups/forms/fd-administrators,/home/groups/forms/forms-users,/home/groups/geometrixx,/home/groups/media,/home/groups/o/operators,/home/groups/projects,/home/groups/t/tag-administrators,/home/groups/t/target-activity-authors,/home/groups/u/user-administrators,/home/groups/w/workflow-editors,/home/groups/w/workflow-users,/home/users/a/admin,/home/users/a/anonymous,/home/users/mac,/home/users/media,/home/users/projects,/home/users/system,/home/rep:policy,/home/users/rep:policy,/home/groups/rep:policy \`
   `segment-old:/opt/aem-source/crx-quickstart/repository /opt/aem-destination/crx-quickstart/repository  upgradeusers.log &`
8. 完了したら、手順 3 に進み、ACL を移行します。  crx2oak を使用して移行できない場合は、代わりに以下のパッケージ移行手順に従ってください。


<b>手順 2B：ユーザーとグループを移行する（パッケージを使用）</b>

LDAP/SAML 認証または CRX2Oak（上記のメソッド A）を使用してユーザーが自動的に読み込まれなかった場合は、ユーザーとグループをパッケージ化できます。  この場合、古いシステムに 2 つの個別のパッケージを作成します（管理者ユーザーと匿名の標準ユーザーを除く）。

1. 上記の手順 1 の結果（「管理者と匿名のユーザーを検索する」）から、匿名ユーザーノードと管理者ユーザーノードのパスをコピーします。

   例：

   /home/users/Q/QY5FIMXeQIbGpwZtQ3Dv — パッケージを作成しているシステムの管理者ユーザー

   /home/users/K/Kj1406Qo9IDODc_nk5Ib — パッケージを作成しているシステム上の匿名ユーザー
2. 「パッケージマネージャ」に移動します。 *http://host:port/crx/packmgr/index.jsp*&#x200B;をクリックし、管理者としてログインします。
3. パッケージ「users」を作成
4. 次の exclude ルール（/home/users フィルター）を使用して、/home/users のパッケージ設定にフィルターを追加します。
   1. /home/users/を除外します。\*/.tokens
   2. exclude /home/users/Q/QY5FIMXeQIbGpwZtQ3Dv
   3. exclude /home/users/K/Kj1406Qo9IDODc_nk5Ib
   4. exclude /home/users/a/admin
   5. exclude /home/users/a/anonymous
   6. exclude /home/users/system
   7. exclude /home/users/geometrixx
   8. exclude /home/users/media
   9. exclude /home/users/projects
   10. exclude /home/users/mac
5. パッケージをビルドします。
6. パッケージをダウンロードします。
7. コンピューター上のパッケージ zip ファイルを解凍します。 `jar -xvf users.zip META-INF/vault/filter.xml`
8. META-INF/vault/filter.xmlファイルをテキストエディターで開きます。
9. mode=&quot;merge&quot;をフィルター…タグに追加します。次に例を示します。






   ```
   ?xml version="1.0" encoding="UTF-8"?    workspaceFilter version="1.0"    filter root="/home/users" mode="merge"    exclude pattern="/home/users/.*/.tokens"/    exclude pattern="/home/users/Q/QY5FIMXeQIbGpwZtQ3Dv"/    exclude pattern="/home/users/K/Kj1406Qo9IDODc_nk5Ib"/    exclude pattern="/home/users/a/admin"/    exclude pattern="/home/users/a/anonymous"/    exclude pattern="/home/users/system"/    exclude pattern="/home/users/geometrixx"/    exclude pattern="/home/users/media"/    exclude pattern="/home/users/projects"/    exclude pattern="/home/users/mac"/    /filter    /workspaceFilter
   ```




10. 変更したパッケージの内容を再圧縮し、変更内容を含めます。

   `jar -uvf users.zip META-INF/vault/filter.xml`
11. /home/groups フィルタールールを含む「groups」パッケージを作成します。
12. グループパッケージに対して、手順 11 ～ 14 を繰り返します。
13. （アップグレードのみ）新しいAEMバージョンへの移行を実行する場合は、新しいローカルAEMインスタンスをインストールします *古いバージョンの*（nosamplecontent を使用）、users パッケージをインストールし、そこに groups パッケージをインストールします。 次に、そのインスタンスで新しいバージョンへのインプレースアップグレードを実行します。 これにより、ユーザーが新しい Oak 表現に変換されます。 インプレースアップグレードの後、ユーザーを再度パッケージ化し、アップグレード対象のインスタンスに移植します。 ユーザーグループに対しても同じ操作を行います。
14. 新しいシステムにユーザーパッケージをインストールします。
15. 新しいシステムに groups パッケージをインストールします。
16. 古いAEMバージョンから 6.3 に移行する場合は、 /useradmin UI に移動し、ユーザー replication-receiver を「administrators」グループに追加します。




<b>手順 3. ACL の移行</b>

ツール (ACS Commons) をAEMにインストールできる場合は、次の手順に従います。

1. ACS Commons をダウンロードしてインストールします。
2. ACL パッケージを作成するには、ここに示す手順に従います。
3. http://aem-host:port/crx/packmgr/index.jsp andに移動し、管理者としてログインします。
4. ACL パッケージをクリックします。
5. 「編集」をクリックします。
6. 「詳細」タブを選択します（下のスクリーンショットを参照）。
7. 「AC 処理」ドロップダウンメニューで「結合」を選択し、宛先システム上の既存の ACL を削除しないようにします。 AEMの異なるバージョン間で ACL を移行する場合は（標準搭載の ACL を削除するのを防ぐ）、これが特に重要です。


次の場合、 *not* ツール (ACS Commons) をAEMにインストールするには、次の手順に従います。 これらのコマンドを実行するマシンは、cURL、Python、Java SDK がインストールされたMac OS、Linux、または Windows（Cygwin を使用）である必要があります。

1. http://src-aem-host:port/crx/packmgr/index.jsp andに移動し、管理者としてログインします。
2. 「ACL-migration」という名前のパッケージを作成します。
3. 「編集」ボタンをクリックします。
4. [ 詳細 ] タブを選択し、[AC 処理モード ] を [ マージ ] に設定します。
5. 保存します。
6. パッケージをビルドし、ダウンロードします。
7. ファイルシステム上で、パッケージに対して次のコマンドを実行し、META-INF/vault/filter.xmlファイルを抽出します。 

   `jar -xvf ACL-migration-1.0.zip META-INF/vault/filter.xml`


8. 同じディレクトリで、次のコマンドを実行して、ソースインスタンスから/content の下の ACL パスの JSON ファイルをダウンロードします（ユーザー名とパスワードを設定し、正しいホストを設定します）。 

   `curl -u admin:admin 'http://aemhost/crx/de/query.jsp?' -G --data-urlencode '_dc=1507011481908&_charset_=utf-8&type=xpath&stmt=/jcr:root/content//element(*,rep:ACL)&showResults=true'  data.json`


9. generate-package-filter.py ファイルを作成し、その中に python コードを貼り付けます。 

   `import` `json`


   `from pprint import` `pprint`





   `with open` `(` `'data.json') as data_file:`


   `    data = json.load(data_file)`





   `print("?xml version=\"1.0\" encoding=\"UTF-8\"?")`


   `print(` `"workspaceFilter version=\"1.0\""` `)`


   `for` `item ` `in` `data` `"results"` `:`


   `    ` `print(` `"filter root=\"{path}\" /"` `.` `format` `(path=item` `"path"` `))`


   `print(` `"/workspaceFilter"` `)`
10. data.json が作成された同じフォルダーから Python スクリプトを実行し、出力をMETA-INF/vault/filter.xmlに保存します（filter.xml の既存の内容は置き換えます）。 

   `python generate-packge-filter.py  META-INF/vault/filter.xml`


11. zip ファイル内の filter.xml を更新するには、次のコマンドを使用します。

   `jar -uvf ACL-migration-1.0.zip META-INF/vault/filter.xml`


12. zip ファイルをソースインスタンスパッケージマネージャー ( http://src-aem-host:port/crx/packmgr/index.jsp ) にアップロードします。
13. 「ビルド」または「リビルド」をクリックして、パッケージをビルドします。
14. ソースAEMサーバーからパッケージをダウンロードします。
15. パッケージを宛先のAEMサーバーのパッケージマネージャーにアップロードします ( http://dst-aem-host:port/crx/packmgr/index.jsp )。
16. 「インストール」をクリックしてインストールします。
17. path curl コマンドを変更する他のパスに対して、手順 8～16 を繰り返します。 例えば、これにより、/content ではなく/etc の下に ACL が取得されます。 

   | <br><br><br>`curl -u admin:admin 'http://aemhost/crx/de/query.jsp?' -G --data-urlencode '_dc=1507011481908&_charset_=utf-8&type=xpath&stmt=/jcr:root/etc//element(*,rep:ACL)&showResults=true'  data.json` |
   | --- |
