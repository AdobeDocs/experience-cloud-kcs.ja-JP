---
title: 「Managed Services Dispatcher のAdobeのフラッシュ」
description: キャッシュのフラッシュとコンテンツのアクティベーションの複雑なプロセスを調べ、システムでのシームレスな更新と最適なパフォーマンスを確保します。
solution: Experience Manager
product: Experience Manager
applies-to: "Experience Manager"
keywords: "KCS, キャッシュのフラッシュメカニズム，Dispatcher ワークフロー，レプリケーションエージェント，アクティベーションプロセス，フラッシュリクエストの処理，シリアル化の種類，Dispatcher 設定，フラッシュリクエストの HTTP メソッド，Stat ファイル構造，タイムスタンプハンドシェイク，キャッシュハンドシェイクの例，ファームファイル設定"
resolution: Resolution
internal-notes: null
bug: false
article-created-by: Utkarsh Jha
article-created-date: "6/18/2024 2:11:37 PM"
article-published-by: Utkarsh Jha
article-published-date: "6/18/2024 2:41:36 PM"
version-number: 6
article-number: KA-17493
dynamics-url: "https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=5c6e3fa8-7c2d-ef11-840b-6045bd006704"
source-git-commit: 3c8b7934e12490286d97d615cecafda9bb62052c
workflow-type: tm+mt
source-wordcount: '0'
ht-degree: 0%

---

# Adobe Managed Services Dispatcher のフラッシュ


システムの効率とデータの整合性を維持するために不可欠な、キャッシュのフラッシュメカニズムとコンテンツアクティベーションワークフローのニュアンスについて説明します。

## 説明 {#description}


### <b>環境</b>

Adobe Experience Manager

### <b>問題／症状</b>

このドキュメントでは、フラッシュがどのように発生するかについてのガイダンスと、キャッシュのフラッシュと無効化を実行するメカニズムについて説明します。
<br>仕組み<br>
<b>操作順序</b>

一般的なワークフローは、コンテンツ作成者がページをアクティブ化するとき、パブリッシャーは新しいコンテンツを受け取ると、次の図に示すように Dispatcher にフラッシュリクエストをトリガーにするときに最もよく表されます。![](assets/___636e3fa8-7c2d-ef11-840b-6045bd006704___.png)

このイベントの連鎖は、新しいアイテムや変更されたアイテムのみをフラッシュすることをハイライトします。  これにより、キャッシュをクリアする前にパブリッシャーがコンテンツを受け取るようになります。変更がパブリッシャーから取得される前にフラッシュが発生する競合状態を避けることができます。

### <b>レプリケーションエージェント</b>

オーサー環境には、パブリッシャーを指すように設定されたレプリケーションエージェントがあり、何かがアクティベートされると、トリガーでそのファイルとすべての依存関係をパブリッシャーに送信します。

パブリッシャーはファイルを受け取ると、受信時イベントをトリガーする Dispatcher を指すように設定されたレプリケーションエージェントを持ちます。  その後、フラッシュリクエストをシリアル化して Dispatcher に POST します。

#### オーサーレプリケーションエージェント

次に、設定済みの標準レプリケーションエージェントの例をスクリーンショットで示します。

![](assets/___656e3fa8-7c2d-ef11-840b-6045bd006704___.png)

通常、オーサーに対して、コンテンツのレプリケート先のパブリッシャーごとに 1 つまたは 2 つのレプリケーションエージェントが設定されます。

1 つは、コンテンツのアクティベーションをプッシュする標準レプリケーションエージェントです。

2 つ目はリバースエージェントです。  これはオプションで、リバースレプリケーションアクティビティとしてオーサーに取り込む新しいコンテンツが各パブリッシャーのアウトボックスにあるかどうかを確認するように設定されています

#### パブリッシャーレプリケーションエージェント

設定済みの標準フラッシュレプリケーションエージェントのスクリーンショットの例を次に示します。

![](assets/___676e3fa8-7c2d-ef11-840b-6045bd006704___.png)

#### 仮想ホストを受け取る DISPATCHER フラッシュレプリケーション

Dispatcher モジュールは特定のヘッダーを探し、POSTリクエストがAEM レンダーに渡すものか、またはフラッシュリクエストとしてシリアル化され、Dispatcher ハンドラー自体で処理する必要があるかを特定します。  次に、これらの値を示す設定ページのスクリーンショットを示します。



![](assets/___696e3fa8-7c2d-ef11-840b-6045bd006704___.png)



デフォルト設定ページには、 <b>シリアル化のタイプ</b> as *Dispatcher フラッシュ* エラーレベルを設定します。



![](assets/___6b6e3fa8-7c2d-ef11-840b-6045bd006704___.png)

「トランスポート」タブをクリックすると、フラッシュリクエストを受け取る Dispatcher の IP アドレスを指すように URI が設定されているのを確認できます。  パス /dispatcher/invalidate.cacheは、フラッシュかどうかをモジュールが判断する方法ではなく、フラッシュリクエストであることがわかるようアクセスログに表示される明白なエンドポイントにほかなりません。  「拡張」タブで、Dispatcher モジュールに対するフラッシュリクエストであると見なすために存在するものを確認します。



![](assets/___6f6e3fa8-7c2d-ef11-840b-6045bd006704___.png)



フラッシュリクエストの HTTP メソッドは、いくつかの特別なリクエストヘッダーを持つ以下のGETリクエストです。

- CQ-Action

  リクエストに基づくAEM変数を使用します。値は通常、です。 *アクティブ化または削除* 


- CQ-Handle リクエストに基づいてAEM変数を使用します。値は通常、フラッシュされた項目の完全パスです（例：） */content/dam/logo.jpg*


- CQ-Path

  リクエストに基づいてAEM変数を使用します。値は通常、フラッシュされる項目の完全パスです（例：） */content/dam*


- ホスト

  ホストヘッダーが特定のをターゲットするようにスプーフィングされる場所です。 `<` VirtualHost`>`  これは、Dispatcher Apache web サーバー（/etc/httpd/conf.d/enabled_vhosts/aem_flush.vhost）で設定されます。  これは、aem_flush.vhost ファイルののエントリに一致するハードコードされた値です。 *ServerName* または *ServerAlias*



  ![](assets/___716e3fa8-7c2d-ef11-840b-6045bd006704___.png)



  「トリガー」タブで、切り替えられたトリガーとその使用方法および内容に注意します。


- <b>デフォルトを無視</b>

  これを有効にすると、ページのアクティベーション時にレプリケーションエージェントがトリガーされなくなります。  これは、オーサーインスタンスがページに変更を加えた場合にフラッシュがトリガーとなるものです。  これはパブリッシャーなので、このタイプのイベントはトリガーにしないでください。


- <b>受信時</b>

  新しいファイルを受け取ったら、フラッシュをトリガーします。  そのため、更新されたファイルをオーサーが送信すると、をトリガーしてフラッシュリクエストを Dispatcher に送信します。


- <b>バージョン管理なし</b>

  新しいファイルを受け取ったので、パブリッシャーが新しいバージョンを生成しないようにするには、これをチェックします。  ファイルを置き換え、パブリッシャーではなくオーサーのバージョン管理を信頼するだけです。


一般的なフラッシュリクエストを curl コマンドで見てみましょう。
<br> <br>

| `$ curl \``-H``"CQ-Action: Activate"` `\``-H``"CQ-Handle: /content/dam/logo.jpg"` `\``-H``"CQ-Path: /content/dam/"` `\``-H``"Content-Length: 0"` `\``-H``"Content-Type: application/octect-stream"` `\``-H``"Host: flush"` `\``http:``//10``.43.0.32:80``/dispatcher/invalidate``.cache` |
| --- |


このフラッシュの例では、ディレクトリ内の.stat ファイルを更新して、/content/dam パスをフラッシュします。

### .stat ファイル

フラッシングメカニズムは本質的にシンプルです。の重要性を説明します。 <b>.stat</b> キャッシュファイルが作成されるドキュメントルートに生成されるファイル。

.vhost ファイルと_farm.any ファイル内で、ドキュメントルートディレクティブを設定して、キャッシュの場所と、エンドユーザーからのリクエストが入ったときにファイルを保存/提供する場所を指定します。

Dispatcher サーバーで次のコマンドを実行すると、.stat ファイルの検索が開始されます。


| 1 | `$``find` `/mnt/var/www/html/` `-``type` `f -name``".stat"` |
| --- | --- |


#### キャッシュに項目があり、Dispatcher モジュールによってフラッシュリクエストが送信および処理されたときに、このファイル構造がどのように見えるかを次の図に示します。

#### ![](assets/___736e3fa8-7c2d-ef11-840b-6045bd006704___.png)

統計ファイルレベル

各ディレクトリには、.stat ファイルが存在します。  これは、フラッシュが発生したことを示すインジケーターです。  上記の例では、 <b>stat ファイルレベル</b> がに設定されました <b>3</b> 対応するファーム設定ファイル内。

stat ファイルレベル設定は、モジュールが.stat ファイルをトラバースして更新するフォルダーの深さを示します。  .stat ファイルは空で、日付スタンプを含むファイル名にすぎず、手動で作成することもできますが、Dispatcher サーバーのコマンドラインで touch コマンドを実行します。

stat ファイルレベルの設定が高すぎると、各フラッシュリクエストが stat ファイルにタッチしているディレクトリツリーをトラバースします。  これは、大きなキャッシュツリーで大きなパフォーマンスヒットになる可能性があり、Dispatcher の全体的なパフォーマンスに影響を与える可能性があります。

このファイルレベルの設定が低すぎると、フラッシュリクエストが意図した以上にクリアされる可能性があります。  これにより、キャッシュから提供されるリクエストが少なくなり、キャッシュがより頻繁にチャーンし、パフォーマンスの問題が発生する可能性があります。

メモ：

適切なレベルで statfilelevel を設定します。  フォルダー構造を見て、多くのディレクトリをトラバースする必要がなく、簡潔なフラッシュができるように設定されていることを確認します。   システムのパフォーマンステスト中にテストして、ニーズに合っていることを確認します。

言語をサポートしているサイトが良い例です。  一般的なコンテンツツリーには、次のディレクトリがあります

/content/brand1/en/us/

この例では、stat ファイルレベル設定の 4 を使用します。  これにより、下にあるコンテンツをフラッシュする際に確実になります。 <b>us</b> 言語フォルダーもフラッシュされないフォルダーです。



#### stat ファイルのタイムスタンプハンドシェイク

コンテンツのリクエストが同じルーチンで発生する場合

1. .stat ファイルのタイムスタンプは、リクエストされたファイルのタイムスタンプと比較されます
2. .stat ファイルがリクエストされたファイルよりも新しい場合、キャッシュされたコンテンツが削除され、AEMから新しいコンテンツが取得されてキャッシュされます。  次に、コンテンツが提供されます
3. .stat ファイルがリクエストされたファイルよりも古い場合、ファイルが新しいことを認識され、コンテンツが提供されます。


#### キャッシュハンドシェイク – 例 1

上記の例では、コンテンツ /content/index.htmlに対するリクエストです。

index.html ファイルの時間は 2019-11-01 @ 6:21PM です

最も近い.stat ファイルの時間は 2019-11-01 @ 12:22PM です

上記の内容を理解すると、インデックスファイルが.stat ファイルよりも新しく、ファイルをリクエストしたエンドユーザーにキャッシュから提供されることがわかります

#### キャッシュハンドシェイク – 例 2

上記の例では、コンテンツ /content/dam/logo.jpgに対するリクエストです。

logo.jpg ファイルの時間は 2019-10-31 @ 1:13PM です

最も近い.stat ファイルの時間は 2019-11-01 @ 12:22PM です

この例でわかるように、ファイルは.stat ファイルより古く、リクエストしたエンドユーザーに提供される前に、削除され、新しいファイルがAEMから取り出されてキャッシュ内で置換されます。
<br>ファームファイル設定<br>
設定オプションの完全なセットに対するすべてのドキュメントについては、「」を参照してください。 [https://docs.adobe.com/content/help/en/experience-manager-dispatcher/using/configuring/dispatcher-configuration.html#configuring-dispatcher_configuring-the-dispatcher-cache-cache](https://docs.adobe.com/content/help/en/experience-manager-dispatcher/using/configuring/dispatcher-configuration.html#configuring-dispatcher_configuring-the-dispatcher-cache-cache)

キャッシュのフラッシュに関連する一部をハイライト表示します

### ドキュメントルート

この設定エントリは、ファームファイルの次のセクションにあります。
<br> <br>

| `/myfarm {``    ``/cache {``        ``/docroot` |
| --- |


Dispatcher がキャッシュディレクトリとしてデータを取り込み、管理するディレクトリを指定します。

メモ：

このディレクトリは、web サーバーが使用するように設定されているドメインの Apache ドキュメントのルート設定と一致する必要があります。

Apache ドキュメントルートのサブフォルダーにある各ファームごとにネストされた docroot フォルダーを持つことは、多くの理由で非常に困難です。



### 統計ファイルレベル

この設定エントリは、ファームファイルの次のセクションにあります。
<br> <br>

| `/myfarm {``    ``/cache {``        ``/statfileslevel` |
| --- |

<br> 
この設定では、フラッシュリクエストが送信されたときに生成される必要がある.stat ファイルの深さを測定します。

/var/www/html/のドキュメントルートで/statfileslevel を次の番号に設定すると、/content/dam/brand1/en/us/logo.jpgのフラッシュ時に次の結果が得られます。

- 0 – 次の統計ファイルが作成されます
   - /var/www/html/.stat
- 1 – 次の統計ファイルが作成されます
   - /var/www/html/.stat
   - /var/www/html/content/.stat
- 2 – 次の統計ファイルが作成されます
   - /var/www/html/.stat
   - /var/www/html/content/.stat
   - /var/www/html/content/dam/.stat
- 3 – 次の統計ファイルが作成されます

   - /var/www/html/.stat
   - /var/www/html/content/.stat
   - /var/www/html/content/dam/.stat
   - /var/www/html/content/dam/brand1/.stat
- 4 – 次の統計ファイルが作成されます

   - /var/www/html/.stat
   - /var/www/html/content/.stat
   - /var/www/html/content/dam/.stat
   - /var/www/html/content/dam/brand1/.stat
   - /var/www/html/content/dam/brand1/en/.stat
- 5 – 次の統計ファイルが作成されます

   - /var/www/html/.stat
   - /var/www/html/content/.stat
   - /var/www/html/content/dam/.stat
   - /var/www/html/content/dam/brand1/.stat
   - /var/www/html/content/damn/brand1/en/.stat
   - /var/www/html/content/damn/brand1/en/us/.stat




メモ：

タイムスタンプのハンドシェイクが発生すると、最も近い.stat ファイルが検索されることに注意します。

.stat ファイルのレベル 0 と stat ファイルを/var/www/html/.stat にのみ配置すると、/var/www/html/content/dam/brand1/en/us/の下にあるコンテンツが、最も近い.stat ファイルを探し、5 つ上のフォルダーを移動して、レベル 0 に存在する唯一の.stat ファイルを見つけ、そのファイルと日付を比較します。  つまり、この高いレベルで 1 回フラッシュすると、キャッシュされたすべてのアイテムが基本的に無効になります。



### 無効化の許可

この設定エントリは、ファームファイルの次のセクションにあります。
<br> <br>

| `/myfarm {``    ``/cache {``        ``/allowedClients {` |
| --- |


この設定内に、フラッシュリクエストを送信できる IP アドレスのリストを配置します。  フラッシュリクエストが Dispatcher に送信される場合、信頼された IP からのリクエストが必要です。  これを誤って設定しているか、信頼されていない IP アドレスからフラッシュリクエストが送信された場合は、ログファイルに次のエラーが表示されます。
<br> <br>

| `[ Mon Nov 11 22:43:05 2019]  [ W]  [ pid 3079 (tid 139859875088128)]  Flushing rejected from 10.43.0.57` |
| --- |


### 無効化ルール

この設定エントリは、ファームファイルの次のセクションにあります。
<br> <br>

| `/myfarm {``    ``/cache {``        ``/invalidate {` |
| --- |


これらのルールは通常、フラッシュリクエストで無効化できるファイルを示します。

ページのアクティベーションによって重要なファイルが無効化されるのを防ぐために、無効化できるファイルと手動で無効化する必要のあるファイルを指定するルールを適用できます。  html ファイルの無効化のみを許可する設定のサンプルセットを次に示します。
<br> <br>

| `/invalidate {``   ``/0000 { /glob "*" /type "deny" }``   ``/0001 { /glob "*.html" /type "allow" }``}` |
| --- |

<br> 

## 解決策 {#resolution}

テスト/トラブルシューティング<br>
ページをアクティベートし、ページのアクティベーションが成功したことを示す緑色の光が表示されたら、アクティベートしたコンテンツがキャッシュからもフラッシュされます。

ページを更新すると、古い情報が表示され、緑色の信号が表示されます。

フラッシュプロセスを手動でいくつか実行し、何が間違っているのかを確認してみましょう。  パブリッシャーのシェルから、curl を使用して次のフラッシュリクエストを実行します。


<br> <br>

| `$ curl -H``"CQ-Action: Activate"` `\``-H``"CQ-Handle: /content/<PATH TO ITEM TO FLUSH>"` `\``-H``"CQ-Path: /content/<PATH TO ITEM TO FLUSH>"` `\``-H``"Content-Length: 0"` `-H``"Content-Type: application/octet-stream"` `\``-H``"Host: flush"` `\``http:``//``<DISPATCHER IP ADDRESS>``/dispatcher/invalidate``.cache` |
| --- |


テストフラッシュリクエストの例
<br> <br>

| `$ curl -H``"CQ-Action: Activate"` `\``-H``"CQ-Handle: /content/customer/en-us"` `\``-H``"CQ-Path: /content/customer/en-us"` `\``-H``"Content-Length: 0"` `-H``"Content-Type: application/octet-stream"` `\``-H``"Host: flush"` `\``http:``//169``.254.196.222``/dispatcher/invalidate``.cache` |
| --- |


リクエストコマンドを Dispatcher に送信したら、ログでの処理と、.stat ファイルでの処理を確認する必要があります。  ログファイルを追跡すると、次のエントリが表示され、フラッシュリクエストが Dispatcher モジュールにヒットしたことを確認できます
<br> <br>

| `[ Wed Nov 13 16:54:12 2019]  [ I]  [ pid 19173:tid 140542721578752]  Activation detected: action=Activate [ /content/dam/logo.jpg]``[ Wed Nov 13 16:54:12 2019]  [ I]  [ pid 19173:tid 140542721578752]  Touched /mnt/var/www/html/.stat``[ Wed Nov 13 16:54:12 2019]  [ I]  [ pid 19173:tid 140542721578752]  Touched /mnt/var/www/html/content/.stat``[ Wed Nov 13 16:54:12 2019]  [ I]  [ pid 19173:tid 140542721578752]  Touched /mnt/var/www/html/content/dam/.stat``[ Wed Nov 13 16:54:12 2019]  [ I]  [ pid 19173:tid 140542721578752]  "GET /dispatcher/invalidate.cache" 200 purge [ publishfarm/-]  0ms` |
| --- |


モジュールが取得され、フラッシュリクエストが承認されたことがわかったら、.stat ファイルへの影響を確認する必要があります。  次のコマンドを実行し、別のフラッシュの実行時にタイムスタンプが更新されることを確認します。
<br> <br>

| `$``watch` `-n 3``"find /mnt/var/www/html/ -type f -name "``.stat``" | xargs ls -la $1"` |
| --- |


コマンド出力から、現在の.stat ファイルのタイムスタンプがわかります
<br> <br>

| `-rw-r--r--. 1 apache apache 0 Nov 13 16:54``/mnt/var/www/html/content/dam/``.stat``-rw-r--r--. 1 apache apache 0 Nov 13 16:54``/mnt/var/www/html/content/``.stat``-rw-r--r--. 1 apache apache 0 Nov 13 16:54``/mnt/var/www/html/``.stat` |
| --- |


もう一度フラッシュを実行して、タイムスタンプの更新を確認します
<br> <br>

| `-rw-r--r--. 1 apache apache 0 Nov 13 17:17``/mnt/var/www/html/content/dam/``.stat``-rw-r--r--. 1 apache apache 0 Nov 13 17:17``/mnt/var/www/html/content/``.stat``-rw-r--r--. 1 apache apache 0 Nov 13 17:17``/mnt/var/www/html/``.stat` |
| --- |


コンテンツのタイムスタンプと.stat ファイルのタイムスタンプを比較しましょう
<br> <br>

| `$ stat``/mnt/var/www/html/content/customer/en-us/``.stat``  ``File: `.stat&#39;``  ``サイズ：0 ブロック：0 I/O ブロック：4096 通常は空``file``デバイス：ca90h``/51856d`    `Inode: 17154125    Links: 1``アクセス：（0644``/-rw-r--r--``） Uid: （48/ apache） Gid: （48/ apache）``Access: 2019-11-13 16:22:31.000000000 -0400``変更：2019-11-13 16:22:31.000000000 -0400``Change: 2019-11-13 16:22:31.000000000 -0400`<br> <br>`$ stat``/mnt/var/www/html/content/customer/en-us/logo``.jpg``ファイル： `logo.jpg'``  ``Size: 15856           Blocks: 32          IO Block: 4096   regular``file``Device: ca90h``/51856d`    `Inode: 9175290    Links: 1``Access: (0644``/-rw-r--r--``)  Uid: (   48/  apache)   Gid: (   48/  apache)``Access: 2019-11-11 22:41:59.642450601 +0000``Modify: 2019-11-11 22:41:59.642450601 +0000``Change: 2019-11-11 22:41:59.642450601 +0000` |
| --- |


タイムスタンプを見ると、どれも.stat ファイルよりも新しいため、キャッシュからファイルを提供するようモジュールに指示する.stat ファイルよりもコンテンツの時間が新しいことがわかります。

明らかに、このファイルのタイムスタンプは更新されており、「フラッシュ」または置換の条件を満たしていません。
