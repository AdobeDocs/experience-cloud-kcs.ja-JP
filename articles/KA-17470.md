---
title: '"エラー：開いているファイルが多すぎます»'
description: 説明
solution: Experience Manager
product: Experience Manager
applies-to: "Experience Manager"
keywords: "KCS"
resolution: Resolution
internal-notes: null
bug: false
article-created-by: Roxann McGlumphy
article-created-date: "10/20/2021 11:05:19 PM"
article-published-by: Roxann McGlumphy
article-published-date: "10/20/2021 11:10:07 PM"
version-number: 1
article-number: KA-17470
dynamics-url: "https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=dc40aa30-fa31-ec11-b6e5-000d3a5ba97a"
exl-id: 534227cf-df15-4255-b699-e26953bf90e6
source-git-commit: e8f4ca2dd578944d4fe399074fab461de88ad247
workflow-type: tm+mt
source-wordcount: '732'
ht-degree: 1%

---

# エラー：開いているファイルが多すぎます

## 説明

<br><br><br>問題<br><br><br><br><br><br>
ログファイルに「Too many files」というエラーが含まれ、AEMは応答しません。
<br><br><br><br><br><br>原因<br><br><br><br><br><br>
原因は次の 2 つの可能性の 1 つです。

- ファイルやソケットなどのリソースを使用した後、アプリケーションが閉じることはありません。
- または、プロセスで許可されている数より多くのオープンファイルがアプリケーションに必要です。



## 解像度

<br><br> <br><br><br><br><br><br>
この問題の解決策は次のとおりです。

1. 何がオープンファイルの制限に達しているかを調べます
2. 制限を増やすか、アプリケーションのバグを修正します。

<br><br><br><br>開いたファイルまたはソケットを探す<br><br> <br><br>
\*\*オープンファイルの制限は、ファイルだけでなく、合計オープンファイル、パイプ、ソケットに適用されることに注意してください。

Linux プラットフォームでは、lsof コマンドを使用して、プロセスが開いたままのリソースをデバッグできます。

次に、役立つ lsof 出力を収集するサンプルスクリプトを示します。
<br><br><br><br><br> <br><br><br><br>

| 1<br>  2<br>  3<br>  4<br>  5<br>  6<br>  7<br>  8<br>  9<br>  10<br>  11<br>  12<br>  13<br>  14<br>  15<br>  16<br>  17<br>  18<br>  19<br>  20<br>  21 | `#!/bin/bash``if` `$``# -eq 0``  ``then``    ``echo` `"No PID specified"``    ``echo` `"Run command with PID, for example:"``    ``echo` `"lsof-script.sh 12345"``    ``exit` `2``fi`<br>   <br>  `JAVA_PROCESS_PID=$1`<br>   <br>  `lsof` `-p $JAVA_PROCESS_PID``lsof``-output-$JAVA_PROCESS_PID.txt`<br>   <br>  `echo` `"Files open by the process:"``cat` `lsof``-output-$JAVA_PROCESS_PID.txt | ``wc` `-l`<br>   <br>  `echo` `"Generated output file with counts of grouped open files lsof-sorted-counts-$JAVA_PROCESS_PID.txt"``cat` `lsof``-output-$JAVA_PROCESS_PID.txt |``awk` `'{print $9}'` `|``sed` `-e``"s/\(.*\)\(segmentstore\).*$/\1\2/"` `| ``sed` `-e``"s/\(.*\)\(repository/index\).*$/\1\2/"` `|``sed` `-e``"s/\(.*\)\(felix/bundle\).*$/\1\2/"` `| ``sed` `-e``"s/\(.*\)\(/lib\).*$/\1\2/"` `| ``sed` `-e``"s/\(.*\)\(/logs\).*$/\1\2/"` `| ``sed` `-e``"s/\(.*\)\(/ext\).*$/\1\2/"` `|``sort` `|``uniq` `-c |``sort` `-rn -k1``lsof``-sorted-counts-$JAVA_PROCESS_PID.txt`<br>   <br>  `echo` `"Total open files in OS:"``lsof` `|``wc` `-l` |
| --- | --- |

<br><br><br><br><br> <br><br>
サンプル出力:
<br><br><br><br><br> <br><br><br><br>

| 1<br>  2<br>  3<br>  4<br>  5<br>  6 | `$ ./lsof-script.sh 18070``Files open by the process:``    ``1995``Generated output file with counts of grouped open files: lsof-sorted-counts-18070.txt``Total open files in OS:``   ``18399` |
| --- | --- |

<br><br><br><br><br> <br><br>
Inspectは生成された lsof-sorted-counts-\*.txt ファイルの出力を返します。  プロセスが現在開いているファイルまたはソケットが表示されます。

開いているソケットやファイルがまだ開いていない場合は、アプリケーションのバグが原因である可能性が高いです。  ファイルとソケットを使用した後に閉じるように、アプリケーションコードを更新します。

オープンソケットが長引く一般的な原因は、Web サービスを作成するカスタムコードです。  多くの場合、Apache Commons HttpClient などのライブラリが使用されますが、開発者は接続を閉じることはありません。  詳しくは、 [この記事](https://stackoverflow.com/questions/43454514/proper-usage-of-apache-httpclient-and-when-to-close-it) Apache Commons HttpClient の詳細
<br><br><br><br> <br><br>シェルセッションの制限を増やします<br><br><br><br> <br><br>
開いているファイルの最大数をユーザーの制限値にチェックし、AEMプロセスを実行するユーザーと同じユーザーとして以下を実行します。

ulimit -Sn ulimit -Hn

AEM/CQ のデフォルトの開始スクリプトを使用する場合は、以下の手順を実行して制限を増やします。

1. crx-quickstart/bin/start を開いて編集
2. スクリプトの先頭に変数 CQ_MAX_OPEN_FILES を追加します。CQ_MAX_OPEN_FILES=8192 export CQ_MAX_OPEN_FILES


&quot;-bash:上限：ファイルを開く：制限を変更できません：AEMの起動時に「操作が許可されていません」と表示された場合、上記の設定は機能しません。

代わりに、/etc/security/limits.confの制限を増やす必要があります。 ユーザー制限の再設定方法の詳細については、以下を参照してください。

JBoss や Websphere などのサードパーティのアプリケーションサーバーを使用している場合は、以下の節に従って、ベンダーのドキュメントを確認してください。

注釈:

この記事のどの設定でも問題が解決しない場合は、コマンド lsof -p を使用してどのファイルが開いているかを確認します。（ —p は問題のあるプロセスのプロセス ID です）。 アプリケーションがファイルハンドルを開いたままにしている可能性があります。 ハンドルが主にAEMで保持され、アプリケーションでは保持されない場合は、サポートにお問い合わせください。


<br><br><br><br> <br><br>ユーザーの制限を増やす<br><br><br><br> <br><br>
root 以外のユーザーが開いているファイルの最大数を変更するには、/etc/security/limits.confファイルを変更します。 制限は、ユーザーごとに設定できます。

crx_process_username soft nofile 8092

crx_process_username hard nofile 20000

注釈:

この設定は、次回ユーザーがログインするまで有効になりません。


<br><br><br><br> <br><br>システム制限を引き上げる<br><br><br><br> <br><br>
場合によっては、ユーザーの上限が十分に高くなっていても、システム自体が最大数のファイルに達している。 su/root ユーザーとして、次のコマンドを実行します。

1. オペレーティングシステムの最大オープンファイル設定を確認します (20000未満の場合は、この設定を増やすと効果的です )。    cat /proc/sys/fs/file-max
2. 次の行を/etc/sysctl.confに追加して、システムオープンファイルの最大値を増やします。fs.file-max = 300000
3. 次のコマンドを実行します。sysctl -p
4. 次のコマンドを実行する際に、新しい値が表示されることを確認します。cat /proc/sys/fs/file-max


注釈:

この設定は、次回ユーザーがログインするまで有効になりません。


<br><br><br><br> <br><br>追加情報<br><br><br><br> <br><br>
このエラーは、システムまたはユーザーが最大数のファイルハンドルを使用している場合に発生します。

ダウンロード
[ファイルを取得](https://helpx.adobe.com/content/dam/help/en/experience-manager/kb/TooManyOpenFiles/jcr:content/main-pars/kb_download/check_open_files.sh "check_open_files.sh") <br><br>開いているファイルの使用状況を監視するために使用できるシェルスクリプト。 このスクリプトは、最大値を増やした後も「開いているファイルが多すぎます」というエラーが持続する場合にのみ使用してください。 または、CRX またはアプリケーションがファイルハンドルを開いたままにしていると思われる場合に使用できます。 スクリプトを使用する前に、次の変数を設定します。JAVA_HOME、QUICKSTART_PATH、OUTPUT_DIR、USER、MAX_FILES_THRESHOLD。 スクリプトを使用するには、cron ジョブとして設定します。
