---
title: 「エラー：開いているファイルが多すぎます」
description: 説明
solution: Experience Manager
product: Experience Manager
applies-to: "Experience Manager"
keywords: "KCS"
resolution: Resolution
internal-notes: null
bug: false
article-created-by: Roxann McGlumphy
article-created-date: "10/20/2021 11:05:19 PM"
article-published-by: Roxann McGlumphy
article-published-date: "10/20/2021 11:10:07 PM"
version-number: 1
article-number: KA-17470
dynamics-url: "https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=dc40aa30-fa31-ec11-b6e5-000d3a5ba97a"
exl-id: 534227cf-df15-4255-b699-e26953bf90e6
source-git-commit: 0c3e421beca46d9fe1952b1f98538a50697216a0
workflow-type: tm+mt
source-wordcount: '641'
ht-degree: 100%

---

# エラー：開いているファイルが多すぎます

## 説明

<br><br><br>問題<br><br><br><br><br><br>
ログファイルに「ファイルが多すぎます」というエラーが含まれ、AEM が応答しません。
<br><br><br><br><br><br>原因<br><br><br><br><br><br>
原因は、次の 2 つの可能性のうちの 1 つです。

- アプリケーションが、ファイルやソケットなどのリソースを使用した後、閉じていない。
- または、アプリケーションが、プロセスで許可されているよりも多くの開いているファイルを必要としている。



## 解決策

<br><br> <br><br><br><br><br><br>
次に、この問題の解決策を示します。

1. 開いているファイルの上限に達している原因を調べる
2. 上限を増やすか、アプリケーションのバグを修正する。

<br><br><br><br>開いたままのファイルまたはソケットを見つける<br><br> <br><br>
\*\* 開いているファイルの上限は、ファイルだけでなく、開いているファイル、パイプおよびソケットを組み合わせた合計に適用されることに注意してください。

[!DNL Linux] プラットフォームでは、プロセスによって開かれたままになっているリソースをデバッグするために、`lsof` コマンドを使用できます。

次に、有用な `lsof` 出力を収集するサンプルスクリプトを示します。
<br><br><br><br><br> <br><br><br><br>

```
#!/bin/bash` `if` `$` `# -eq 0` `  ` `then` `    ` `echo` `"No PID specified"` `    ` `echo` `"Run command with PID, for example:"` `    ` `echo` `"lsof-script.sh 12345"` `    ` `exit` `2` `fi`<br>   <br>  `JAVA_PROCESS_PID=$1`<br>   <br>  `lsof` `-p $JAVA_PROCESS_PID` `lsof` `-output-$JAVA_PROCESS_PID.txt`<br>   <br>  `echo` `"Files open by the process:"` `cat` `lsof` `-output-$JAVA_PROCESS_PID.txt | ` `wc` `-l`<br>   <br>  `echo` `"Generated output file with counts of grouped open files lsof-sorted-counts-$JAVA_PROCESS_PID.txt"` `cat` `lsof` `-output-$JAVA_PROCESS_PID.txt |` `awk` `'{print $9}'` `|` `sed` `-e` `"s/\(.*\)\(segmentstore\).*$/\1\2/"` `| ` `sed` `-e` `"s/\(.*\)\(repository/index\).*$/\1\2/"` `|` `sed` `-e` `"s/\(.*\)\(felix/bundle\).*$/\1\2/"` `| ` `sed` `-e` `"s/\(.*\)\(/lib\).*$/\1\2/"` `| ` `sed` `-e` `"s/\(.*\)\(/logs\).*$/\1\2/"` `| ` `sed` `-e` `"s/\(.*\)\(/ext\).*$/\1\2/"` `|` `sort` `|` `uniq` `-c |` `sort` `-rn -k1` `lsof` `-sorted-counts-$JAVA_PROCESS_PID.txt`<br>   <br>  `echo` `"Total open files in OS:"` `lsof` `|` `wc` `-l` 
```


<br><br><br><br><br> <br><br>
サンプル出力：
<br><br><br><br><br> <br><br><br><br>

```
 $ ./lsof-script.sh 18070 Files open by the process:      1995 Generated output file with counts of grouped open files: lsof-sorted-counts-18070.txt Total open files in OS:     18399 
```

<br><br><br><br><br> <br><br>
生成された `lsof-sorted-counts-\*.txt` ファイルの出力を検査します。これは、どのファイルやソケットが、現在、プロセスによって開かれたままになっているかを示します。

まだ開いていないはずのソケットやファイルがリストされている場合、アプリケーションのバグが原因である可能性があります。ファイルやソケットを使用したら閉じるように、アプリケーションコードを更新してください。

開いているソケットが存在し続ける一般的な原因は、web サービスを作成するカスタムコードです。多くの場合、[!DNL Apache] [!DNL Commons HttpClient] のようなライブラリが使用されていますが、開発者によって接続が閉じられることはありません。[!DNL Apache] [!DNL Commons HttpClient] について詳しくは、[この記事](https://stackoverflow.com/questions/43454514/proper-usage-of-apache-httpclient-and-when-to-close-it)を参照してください。<br><br><br><br> <br><br>シェルセッションの上限を増やす<br><br><br><br> <br><br>
開いているファイルの最大数に関するユーザーの上限を確認して、AEM プロセスを実行しているのと同じユーザーで次を実行します。

`ulimit -Sn ulimit -Hn`

AEM／CQ のデフォルトの start スクリプトを使用している場合は、次のようにして上限を増やします。

1. 編集のために `crx-quickstart/bin/start` を開きます
2. スクリプトの先頭に変数 `CQ_MAX_OPEN_FILES` を追加します。`CQ_MAX_OPEN_FILES=8192 export CQ_MAX_OPEN_FILES`


AEM の起動時に `-bash: ulimit: open files: cannot modify limit: Operation not permitted` というエラーが表示される場合は、前述の設定は動作しません。

代わりに、`/etc/security/limits.conf` で上限を増やす必要があります。ユーザーの上限の再設定方法について詳しくは、後述の説明を参照してください。

[!DNL JBoss] や [!DNL Websphere] などのサードパーティのアプリケーションサーバーを使用している場合は、後述の節に従って、ベンダーのドキュメントで検証してください。

メモ：

この記事のどの設定でも問題が解決しない場合は、`lsof -p` コマンドを使用して、どのファイルが開かれているかを確認します（`-p` は問題のあるプロセスのプロセス ID）。アプリケーションがファイルハンドルを開いたままにしている可能性があります。ハンドルが主にアプリケーションではなく AEM によって保持されていることがわかった場合は、サポートにお問い合わせください。


<br><br><br><br> <br><br>ユーザーの上限を増やす<br><br><br><br> <br><br>
非 root ユーザーの開いているファイルの最大数を変更するには、`/etc/security/limits.conf` ファイルを変更します。ユーザーごとに上限を設定できます。

`crx_process_username soft nofile 8092`

`crx_process_username hard nofile 20000`

メモ：

この設定は、次回ユーザーがログインするまで有効になりません。


<br><br><br><br> <br><br>システムの上限を増やす<br><br><br><br> <br><br>
場合によっては、ユーザーの上限は十分高いが、システム自体がファイルの最大数に達していることがあります。`su/root` ユーザーとして、次を実行します。

1. オペレーティングシステムの開いているファイル設定の最大値を確認します（20,000 以下の場合、この設定を増やすことは合理的です）：`cat /proc/sys/fs/file-max`
2. `/etc/sysctl.conf` に次の行を追加して、システムの開いているファイルの最大値を増やします：`fs.file-max = 300000`
3. 次のコマンドを実行します：`sysctl -p`
4. 次のコマンドを実行した場合に、新しい値が表示されることを検証します：`cat /proc/sys/fs/file-max`


メモ：

この設定は、次回ユーザーがログインするまで有効になりません。


<br><br><br><br> <br><br>追加情報<br><br><br><br> <br><br>
このエラーは、システムまたはユーザーが最大数のファイルハンドルを使用している際に発生します。

ダウンロード
[ファイルを入手](https://helpx.adobe.com/content/dam/help/en/experience-manager/kb/TooManyOpenFiles/jcr:content/main-pars/kb_download/check_open_files.sh "check_open_files.sh") <br><br>開いているファイルの使用状況を監視するために使用できるシェルスクリプトです。このスクリプトは、最大値を上げても「開いているファイルが多すぎます」エラーが解決しない場合にのみ使用します。または、CRX やアプリケーションがファイルハンドルを開いたままにしている疑いがある場合にも使用できます。このスクリプトを使用する前に、変数 `JAVA_HOME`、`QUICKSTART_PATH`、`OUTPUT_DIR`、`USER`、`MAX_FILES_THRESHOLD` を設定します。このスクリプトを使用するには、cron ジョブとして設定します。
