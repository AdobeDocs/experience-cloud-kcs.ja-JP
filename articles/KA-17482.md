---
title: 「メモリの問題を分析」
description: 説明
solution: Experience Manager
product: Experience Manager
applies-to: "Experience Manager"
keywords: "KCS"
resolution: Resolution
internal-notes: null
bug: false
article-created-by: Roxann McGlumphy
article-created-date: "10/21/2021 5:18:56 PM"
article-published-by: Roxann McGlumphy
article-published-date: "10/21/2021 5:21:24 PM"
version-number: 1
article-number: KA-17482
dynamics-url: "https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=ef6bccf5-9232-ec11-b6e5-000d3a5ba97a"
exl-id: 48e49bcc-3d49-464e-8af9-e4292b1d6899
source-git-commit: e8f4ca2dd578944d4fe399074fab461de88ad247
workflow-type: tm+mt
source-wordcount: '888'
ht-degree: 1%

---

# メモリの問題を分析

## 説明

<br>症状<br><br>
Java アプリケーションの実行速度が遅くなり、最終的にメモリが不足する場合、またはログまたはコンソール出力にエラーが表示されます `OutOfMemoryError: Java heap space` または `OutOfMemoryError: gc overhead limit exceeded`.
<br><br>原因<br><br>
そのような問題は多くの原因を持つことができます。

考えられる原因の 1 つは、Java アプリケーション（この例では、CRX/CQ）が、Java のデフォルトのヒープメモリ設定を持つコマンドラインから開始されたことです。 これは、jvm パラメーターを意味します。 `-Xmx` が指定されていません。 CRX または CQ は、実行に少なくとも 256 MB のヒープを割り当てる必要があります。 問題が発生した場合は、コマンドラインから始めて、ヒープメモリ設定が設定されていることを確認します。 例：


```
java -Xmx512m -jar *.jar
```


これが該当しない場合は、ガベージコレクション用にリリースせずに、アプリケーションが保持するオブジェクトが多すぎる可能性があります。 これはメモリリークと呼ばれ、 [ここ](http://java.sun.com/javase/6/webnotes/trouble/TSG-VM/html/memleaks.html) を参照してください。 Java アプリケーションのメモリ問題を分析する方法については、以下の節を参照してください。


## 解像度

ヒープダンプを作成<br><br>ヒープダンプを自動的に生成<br><br>
メモリ不足時にヒープダンプを自動的に作成するには、jvm パラメーターを追加します `-XX:+HeapDumpOnOutOfMemoryError` ：アプリケーションが OutOfMemoryError をスローしたときに、ヒープダンプを自動的に生成します。 例：


```
java -Xmx256m -XX:+HeapDumpOnOutOfMemoryError -jar *.jar
```


これにより、ヒープダンプファイル (`java_...hprof`) を、java プロセスのメモリが不足した場合に常に、プロセスの作業ディレクトリに追加します。 ヒープダンプが生成された後も、プロセスは引き続き実行できます。 通常、1 つのヒープダンプファイルで問題を分析できます。

<b>注意：</b> を使用している場合は、 `crx-quickstart/server/start` CRX インスタンスを起動するスクリプトを追加します。 `-XX:+HeapDumpOnOutOfMemoryError` から `CQ_JVM_OPTS` 変数にコメントを付けずに、変数のコメントを必ず外します。 例：


```
CQ_JVM_OPTS='-XX:+HeapDumpOnOutOfMemoryError'
```


このパラメーターを追加して CRX インスタンスを再起動した後、新しい jvm オプションが設定されていることを確認します。 実行 `ps -ef | grep java` コマンドラインから。 次に、 `-XX:+HeapDumpOnOutOfMemoryError` を CRX java プロセスのパラメーターとして設定します。

ディスク容量の制限により、別のディレクトリを指定してヒープダンプを生成する必要がある場合は、 `-XX:HeapDumpPath=/path/to/generate/heapdump` jvm にファイルを配置する場所を指定するためのパラメーター。

詳しくは、 [ここ](http://java.sun.com/javase/technologies/hotspot/vmoptions.jsp#DebuggingOptions) デバッグ関連の jvm パラメーターの参照用。
<br><br>ヒープダンプを手動で生成する<br><br>
<b>Sun/OracleJVM</b>

ヒープダンプを手動で生成するには、次のコマンドを実行します (jmap と jps は `bin` jdk ホームディレクトリのフォルダ ):

1. ヒープダンプを生成する java プロセスの pid を調べます。
   - Unix または Linux では、 `ps -ef | grep java` または `jps -l`
   - Windows では、タスクマネージャを開いて、 `Ctrl+Shift+Esc` その後、 <b>表示</b> = <b>列を選択</b> = <b>PID (Process Identifier)</b> または `jps -l`
2. 以下の jmap コマンドを実行し、 `/path/to/generate/heapdumpfile.hprof` ヒープダンプファイルを生成する場所を指定し、 `1234` 前の手順で参照した pid を使用して、

   ```
   jmap -dump:format=b,file=/path/to/generate/heapdumpfile.hprof 1234
   ```


<b>IBM JVM</b>

最初にダンプエージェントに関するデフォルトの JVM 設定を変更し、ユーザーシグナルに対する正しいダンプを生成する必要があります。 ダンプにはいくつかの種類がありますが、通常は完全な <b>システムダンプ</b> 徹底的なメモリ解析を行う。 次の引数を追加します。

<b>Xdump:heap:opts=PHD+CLASSIC:events=user -Xdump:system:events=user</b>

JVM が SIGQUIT(Linux、AIX®、z/OS®、i5/OS™) または SIGBREAK(Windows) シグナルをオペレーティングシステムから受け取ったときに発生するこの「ユーザー」イベント。

詳しくは、ベンダーのドキュメントを参照してください [ここ](http://pic.dhe.ibm.com/infocenter/java7sdk/v7r0/index.jsp?topic=%2Fcom.ibm.java.aix.70.doc%2Fdiag%2Fpreface%2Fchanges_70%2Foverview_gc.html).

<b>警告：</b> ヒープダンプファイルは大きく、ディスク上の最大ヒープ —Xmx jvm パラメーター設定と同じサイズにすることができます。 ダンプファイルが生成されるディレクトリに十分なディスク領域が割り当てられていることを確認します。
<br><br>ヒープダンプを分析<br><br>
ヒープダンプを分析するのに適したツールは、EclipseMAT(Eclipse Memory Analyzer) です。 [http://www.eclipse.org/mat/](http://www.eclipse.org/mat/)

このツールは分析できません <b>IBM JVM</b> 生成されたダンプ。 それらのために、いくつかの可能性があります。 [IBM HeapAnalyzer](https://www.ibm.com/developerworks/community/groups/service/html/communityview?communityUuid=4544bafe-c7a2-455f-9d43-eb866ea60091) は、PHD またはクラシック形式のヒープダンプに対して適切に機能します。

完全なシステムダンプ分析を行うには、 [IBM Support Assistant Workbench](http://www-01.ibm.com/software/support/isa/) を [Java 用IBM監視および診断ツール — Memory Analyzer バージョン 1.2](http://www.ibm.com/developerworks/java/jdk/tools/memoryanalyzer/) 上部にインストールされます。
<br><br>ヒープヒストグラム<br><br>
ヒープヒストグラムは、Java クラスごとに使用されるライブオブジェクトとメモリの数を単純に測定するものです。 残念ながら、Java のインストールによっては、必要なツールが使用できない場合や、必ずしも機能しない場合があります。 ヒープヒストグラムを作成するには、まず Java プロセスのプロセス ID が必要です。 取得するには、を実行します。 `ps` または（使用可能な場合）、次を実行します。


```
jps -l
```


この Java ツールは、実行中のすべての Java プロセスのプロセス ID を取得します。 例：


```
327 
3332 sun.tools.jps.Jps
3313 crx-quickstart-....jar
```


次のコマンドを実行します。


```
jmap -histo 3313
```


リストは、必要な合計メモリ量 ( シャロー：参照オブジェクトを除外 )。 出力の最初の 20 行が最も興味深いものです。 出力例：


```
JVM version is 1.5.0_20-141
Iterating over heap. This may take a while...
Warning: skipping invalid TLAB for thread t@62211
Warning: skipping invalid TLAB for thread t@62467
...
SizeCountClass description
-------------------------------------------------------
1059290412916byte
1028584075255* ConstMethodKlass
628317658388char
604230414928int
4995752116201* SymbolKlass
422089675255* MethodKlass
41965126969* ConstantPoolKlass
29285606969* InstanceKlassKlass
26310086066* ConstantPoolCacheKlass
2395872149742org.apache.jackrabbit.core.query.lucene.DocId$PlainDocId
14760087003java.util.HashMap$Entry
139612858172java.lang.String
107023244593java.util.HashMap$Entry
75398410036short
73546454org.apache.jackrabbit.core.query.lucene.DocId
7201927502java.lang.Class
64070413348com.day.crx.persistence.tar.index.IndexEntry
...
```


<b>追加情報</b>

問題の分析に役立つように、以下の情報も知っておく必要があります。

- CRX または CQ のバージョン（インストールされているすべてのホットフィックスのバージョン番号の一覧を含む）。
- オペレーティングシステム、JVM ベンダー、およびバージョン。


<b>参照</b>

1 [http://java.sun.com/javase/6/webnotes/trouble/TSG-VM/html/memleaks.html](http://java.sun.com/javase/6/webnotes/trouble/TSG-VM/html/memleaks.html)
2 [http://java.sun.com/javase/technologies/hotspot/vmoptions.jsp#DebuggingOptions](http://java.sun.com/javase/technologies/hotspot/vmoptions.jsp#DebuggingOptions)
