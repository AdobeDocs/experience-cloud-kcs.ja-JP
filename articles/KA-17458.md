---
title: の最適化 [!DNL Dispatcher] キャッシュ
description: 説明
solution: Experience Manager
product: Experience Manager
applies-to: Experience Manager
keywords: KCS
resolution: Resolution
internal-notes: null
bug: false
article-created-by: Roxann McGlumphy
article-created-date: 10/20/2021 7:12:29 PM
article-published-by: Cedric Latimier
article-published-date: 1/18/2022 1:45:44 PM
version-number: 1
article-number: KA-17458
dynamics-url: https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=ee6e74a7-d931-ec11-b6e5-000d3a5ba97a
exl-id: 84871fce-d53d-4a1d-aabf-ccf8c8c47810
source-git-commit: 0c3e421beca46d9fe1952b1f98538a50697216a0
workflow-type: tm+mt
source-wordcount: '1411'
ht-degree: 2%

---

# の最適化 [!DNL Dispatcher] キャッシュ

## 説明


この記事では、AEM Dispatcher の最新の最適化と、それらを最も有効に活用する方法に焦点を当てています。  AEM Dispatcher はキャッシュです [リバースプロキシ](https://stackoverflow.com/questions/224664/difference-between-proxy-server-and-reverse-proxy-server) Adobe Experience Managerで使用するように設計されたサーバー。  既存の Web サーバーソフトウェア内にモジュールとしてインストールし、実行することができます。  この記事を書く時点で、 [dispatcher モジュールはサポートされています](https://helpx.adobe.com/jp/experience-manager/dispatcher/using/dispatcher-install.html) オン [!DNL Apache HTTP Server], Microsoft IIS および [!DNL iPlanet].


## 解像度

<br><br>Dispatcher のキャッシュの仕組み<br><br><br><br><br><br>
最も基本的なレベルでは、AEM Dispatcher は、キャッシュ、キャッシュのフラッシュ、キャッシュの無効化を実行することで機能するリバースプロキシです。

Dispatcher について詳しくは、関連リンクを参照してください。

1. [Dispatcher の仕組みとインストール方法](https://experienceleague.adobe.com/docs/experience-manager-dispatcher/using/dispatcher.html?lang=ja).
2. [Dispatcher で使用可能な設定オプション](https://helpx.adobe.com/jp/experience-manager/dispatcher/using/dispatcher-configuration.html).
3. [Dispatcher の仕組みに関するウェビナー](https://github.com/cqsupport/webinar-dispatchercache)  — プレゼンテーションの一部の情報は、古いバージョンの dispatcher に基づいています。
4. [Dispatcher 機能、CDN 使用、セキュリティに関する Gems ウェビナーセッション](https://docs.adobe.com/ddc/en/gems/dispatcher-caching---new-features-and-optimizations.html).
5. [Dispatcher の新機能に関する Gems セッション（v4.1.9 以降）](https://helpx.adobe.com/experience-manager/kt/eseminars/gems/aem-dispatcher.html).

<br><br><br><br><br><br>Dispatcher キャッシュの最適化<br><br><br><br><br><br>
以下に、Dispatcher のキャッシュを最適化する方法を示します。

1. <b>ほとんどすべてをキャッシュ</b> ：ユーザーが複数回リクエストしたコンテンツをキャッシュします。
2. <b>パーソナライズされたコンテンツを様々な期間キャッシュ</b>  — サイトにパーソナライズされたコンテンツが含まれている場合は、 [[!DNL Apache Sling Dynamic Includes]](https://helpx.adobe.com/experience-manager/kt/platform-repository/using/sling-dynamic-include-technical-video-setup.html) を使用して、 [!DNL Ajax] （ブラウザレベルでの非同期 JavaScript および XML 呼び出し）、SSI（Web サーバーレベルでのサーバー側の組み込み）、ESI（CDN レベルでのエッジ側の組み込み）は、異なる期間、ページの異なる部分をキャッシュします。
3. <b>ライブディスパッチャー上の Dispatcher キャッシュを削除しないでください</b> - Dispatcher がライブコンテンツを提供していて、キャッシュを削除した場合、大量のリクエストがAEMに戻されます。  このため、ライブ Dispatcher では Dispatcher キャッシュを削除しないでください。
4. <b>キャッシュのプライミング </b> — を削除する前に [!DNL Dispatcher] キャッシュ、プル [!DNL Dispatcher] ロードバランサーから、キャッシュを削除し、web クローラーツールを実行して、ファイルをロードバランサーに配置する前に dispatcher 上でファイルをキャッシュします。
5. <b>キャッシュエラーページ</b> - <b>[DispatcherPassError 1](https://helpx.adobe.com/experience-manager/dispatcher/using/dispatcher-install.html#ApacheWebServer) </b>([!DNL Apache] Dispatcher キャッシュから 404s などのエラーページを提供する Web サーバー固有の ) ディレクティブ。
6. <b>GZip は、事前に圧縮されたファイルを除くすべてのファイルタイプを圧縮します </b> — 入力 [!DNL Apache] Web サーバー、 [mod_deflate](https://httpd.apache.org/docs/2.4/mod/mod_deflate.html) を使用できますが、次の点を確認してください。 <b>`Vary: User-Agent` </b>ヘッダー<b> </b>が設定されていません。  Microsoft IIS で、 [動的圧縮](https://docs.microsoft.com/en-us/iis/configuration/system.webserver/httpcompression/).

   [!DNL Apache] 設定例（事前圧縮されたファイルタイプを避けるために特定のコンテンツタイプのみを指定）:

   `AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript`
7. <b>有効にする [/serveStaleOnError](https://helpx.adobe.com/experience-manager/kb/ServeStaleContentOnError.html)</b> 内 `/cache` 設定 — AEMインスタンスがエラーを処理する際に、古いキャッシュファイルを提供します。
8. <b>追加 [/gracePeriod](https://docs.adobe.com/content/help/en/experience-manager-dispatcher/using/configuring/dispatcher-configuration.html#configuring-the-dispatcher-cache-cache)</b> から `/cache` 設定 — 自動的に無効化された古いリソースを、最後のコンテンツ公開イベント (「activation」) 後にキャッシュから引き続き使用できる秒数を定義します。  これにより、「ツリーのアクティベーション」などの大規模なコンテンツ公開アクティビティ中にパブリッシュインスタンスに戻る要求の数が減ります。
9. <b>ルールの追加先 [/ignoreUrlParams](https://helpx.adobe.com/experience-manager/dispatcher/using/dispatcher-configuration.html#IgnoringURLParameters)</b>  — アプリケーションで不要な、または使用されないクエリ文字列パラメーターを無視します。  これにより、クエリ文字列が存在する場合でも URL をキャッシュできます。
10. <b>Cache-Control および Last-Modified 応答ヘッダーのキャッシュ</b> -<b> [/headers](https://helpx.adobe.com/experience-manager/dispatcher/using/dispatcher-configuration.html#CachingHTTPResponseHeaders)</b> HTTP 応答ヘッダーをキャッシュする設定 <b>`Cache-Control`</b> および <b>`Last-Modified` </b>( および/または <b>`ETag`</b> ヘッダー (AEMから送信する場合 )。  これにより、CDN およびブラウザーレベルでのキャッシュを簡素化し、最適化するのに役立ちます。  これらのヘッダーをキャッシュすると、Web サーバー自体ではなく、AEMがヘッダーのみを設定するようになります。  この場合、AEMアプリケーションからヘッダーの送信を開始する必要があります。
11. <b>コンテンツを可能な限り長くキャッシュ</b> および <b>AEMに戻る要求の削減</b>  — を有効にしてフラッシュリクエストを最適化します [再取得中](https://helpx.adobe.com/experience-manager/kb/optimizing-the-dispatcher-cache.html#refetching-flush) すべてのフラッシュエージェントをフラッシュします。  または、 [<b>/enableTTL</b>](https://helpx.adobe.com/experience-manager/kb/optimizing-the-dispatcher-cache.html#use-ttls) および設定 <b>`Cache-Control: max-age=...`</b> 可能な限り長くファイルをキャッシュするヘッダー。  詳しくは、 [下](https://helpx.adobe.com/experience-manager/kb/optimizing-the-dispatcher-cache.html#use-ttls) を参照してください。

<br><br><br><br><br><br>TTL の使用<br><br><br><br><br><br>
現在 [!DNL Dispatcher] バージョン 4.1.11, [/enableTTL 1](https://helpx.adobe.com/experience-manager/dispatcher/using/dispatcher-configuration.html#ConfiguringTimeBasedCacheInvalidationenableTTL) は `.any` ファイル設定。  この設定により、Dispatcher が HTTP で設定されたキャッシュの有効期限を考慮するようになります `Cache-Control` 応答ヘッダー。  つまり、Dispatcher は CDN と同様に機能します。この CDN では、ファイルの有効期限が切れたときにキャッシュの無効化のプライマリ形式が発生します。  これを実装し、送信を開始したら、 <b>`Cache-Control: max-age=...` </b>AEMからのすべての応答に対して、パブリッシュインスタンスで dispatcher フラッシュエージェントを安全に無効にできます。

パブリッシュインスタンスでフラッシュエージェントを無効にした後でも、Dispatcher キャッシュをフラッシュできるようにする必要がある場合があります。  その場合、 [ACS Commons - Dispatcher フラッシュ UI](https://adobe-consulting-services.github.io/acs-aem-commons/features/dispatcher-flush-ui/index.html).  このツールは、オーサーインスタンスにインストールされます。  ユーザーは、手動でキャッシュのフラッシュリクエストを実行できる UI を提供します。

<b>I. TTL（「有効期限」または有効期限）スタイルの無効化を有効にする手順：</b>

1. 送信するAEMアプリケーションのソースコードを変更 <b>`Cache-Control` </b>ヘッダーと <b>`Last-Modified` </b>設定されていないすべてのリクエストに対して実行されます。
2. インストール [!DNL Dispatcher] 4.1.11 以降。
3. 設定 <b>[/enableTTL 1](https://helpx.adobe.com/experience-manager/dispatcher/using/dispatcher-configuration.html#ConfiguringTimeBasedCacheInvalidationenableTTL)</b> 内 `.any` サイトのファーム設定。
4. を <b>[/headers](https://helpx.adobe.com/experience-manager/dispatcher/using/dispatcher-configuration.html#CachingHTTPResponseHeaders) </b>キャッシュする設定 <b>`Cache-Control`</b> および <b>`Last-Modified`</b> ヘッダー。
5. Web サーバーを再起動します。


<b>2. パブリッシュインスタンスで Dispatcher フラッシュエージェントを無効にします。</b>

これで、Dispatcher は `Cache-Control` キャッシュファイルの無効化を制御するヘッダー。  その場合、Dispatcher をパブリッシュインスタンスからフラッシュする必要はなくなりました。

1. に移動します。 `/etc/replication/agents.publish.html` 各パブリッシュインスタンスで
2. 各フラッシュエージェントの設定に移動し、エージェントを無効にします。


<b>三 オーサーインスタンスからの手動の Dispatcher フラッシュ要求を許可します。</b>

フラッシュエージェントが無効になったので、 <b>`Cache-Control` </b>コンテンツを Dispatcher で更新するタイミングを制御するヘッダー。  引き続き、ユーザーが Dispatcher キャッシュの手動フラッシュを発行できます。

1. インストール [ACS Commons - Dispatcher フラッシュ UI](https://adobe-consulting-services.github.io/acs-aem-commons/features/dispatcher-flush-ui/index.html) オーサーインスタンス上で
2. オーサーインスタンスでフラッシュエージェントを設定します。
3. 各エージェント設定で、 <b>トリガー</b> = <b>デフォルトを無視 </b>オプションを有効にします。 このオプションを選択すると、ユーザーがクリックしたときにフラッシュエージェントが無視されます <b>（非）公開 </b>または <b>（無効）有効化</b> (AEM UI 内 )

<br><br><br><br><br><br>Dispatcher フラッシュの再取得<br><br><br><br><br><br>
ディスパッチャーフラッシュリクエストを最適化するには、すべてのディスパッチャーフラッシュエージェントで、フラッシュの再取得と呼ばれる機能を有効にする必要があります。

ディスパッチャーフラッシュの再取得を有効にするには、以下の手順を実行します。

1. に移動します。 <b>*http://aemhost:port*/crx/packmgr/index.jsp</b> 管理者としてログインします。
2. パッケージのダウンロード元 [ここ](https://github.com/cqsupport/webinar-dispatchercache/blob/master/packages/dispatcher-flush-refetch-samplecode-1.0.zip?raw=true).
3. パッケージマネージャーにパッケージをアップロードしてインストールします。
4. Dispatcher フラッシュエージェントの設定に移動します。 例： <b>/etc/replication/agents.author/flush.html</b>
5. クリック <b>[!UICONTROL 編集]</b>
6. 以下を設定します。
   - <b>シリアル化の種類</b> = <b>Dispatcher フラッシュを再取得</b>
   - <b>拡張</b> = <b>HTTP メソッド</b> = <b>POST</b>
7. クリック <b>[!UICONTROL 保存]</b>


上記でインストールしたパッケージは、基本的な例に過ぎません。  フラッシュの再取得をカスタマイズし最適化するには、送信する URI のリストを変更します。  コードはオープンソースで、次の場所にあります： [ここ](https://github.com/cqsupport/webinar-dispatchercache/tree/master/src/refetching-flush-agent/refetch-bundle).  このコードは、URI のリストをリクエスト本文にパラメーターとして追加し、Dispatcher に対して、再取得するパスを示します。  アプリケーション要件に応じてパスを追加し、サイトのキャッシュ機能を最適化できます。
<br><br><br><br><br><br>フラッシュの再取得の詳細な説明<br><br><br><br><br><br>
通常、Dispatcher フラッシュはファイルを削除することで機能します。

1. タッチ `.stat` ファイル
2. 削除 `/content/foo.\*`
3. 削除 `/content/foo/_jcr_content`


手順 2 でファイルが削除されるので、次回ユーザーが次のようなファイルをリクエストしたとき `/content/foo.html` または `/content/foo.json`ファイルが「再取得」されている間は、ファイルがキャッシュされるまで、同じファイルに対する以降の要求もパブリッシュインスタンスに送信されます。  応答が遅い場合や、ホームページなどの大量のトラフィックページの場合、パブリッシュインスタンス層のフラッディングが発生する可能性があります。

この問題を解決するには、Dispatcher の再取得と呼ばれる機能を有効にします。  この機能を使用すると、Dispatcher が事前に「再取得」し、削除ではなく置き換える必要がある URI のリストを送信できます。

22 を参照:41-27:05 件 [発表録画](https://my.adobeconnect.com/p7th2gf8k43) の仕組みと設定方法に関するデモを参照してください。
