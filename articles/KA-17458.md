---
title: ' [!DNL Dispatcher]  キャッシュの最適化'
description: 説明
solution: Experience Manager
product: Experience Manager
applies-to: Experience Manager
keywords: KCS
resolution: Resolution
internal-notes: null
bug: false
article-created-by: Roxann McGlumphy
article-created-date: 10/20/2021 7:12:29 PM
article-published-by: Cedric Latimier
article-published-date: 1/18/2022 1:45:44 PM
version-number: 1
article-number: KA-17458
dynamics-url: https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=ee6e74a7-d931-ec11-b6e5-000d3a5ba97a
exl-id: 84871fce-d53d-4a1d-aabf-ccf8c8c47810
source-git-commit: 0c3e421beca46d9fe1952b1f98538a50697216a0
workflow-type: tm+mt
source-wordcount: '1411'
ht-degree: 100%

---

# [!DNL Dispatcher] キャッシュの最適化

## 説明


この記事では、AEM Dispatcher 内の最新の Dispatcher とこれらの最適な活用法に焦点を当てます。AEM Dispatcher は Adobe Experience Manager で使用するように設計されたキャッシュ[リバースプロキシ](https://stackoverflow.com/questions/224664/difference-between-proxy-server-and-reverse-proxy-server)サーバーです。既存の web サーバーソフトウェア内にモジュールとしてインストールして実行できます。この記事の作成時点では、[Dispatcher モジュール](https://helpx.adobe.com/jp/experience-manager/dispatcher/using/dispatcher-install.html)は、[!DNL Apache HTTP Server]、Microsoft IIS および [!DNL iPlanet] でサポートされています。


## 解決策

<br><br>Dispatcher キャッシングの仕組み<br><br><br><br><br><br>
最も基本的なレベルでは、AEM Dispatcher は、キャッシュの実行、キャッシュのフラッシュおよびキャッシュの無効化によって作動するリバースプロキシです。

Dispatcher について詳しくは、関連リンクを参照してください。

1. [Dispatcher の作動方法とインストールする方法](https://helpx.adobe.com/jp/experience-manager/dispatcher/using/dispatcher.html)。
2. [Dispatcher で使用できる設定オプション](https://helpx.adobe.com/jp/experience-manager/dispatcher/using/dispatcher-configuration.html)。
3. [Dispatcher の作動方法のウェビナー](https://github.com/cqsupport/webinar-dispatchercache) - プレゼンテーションの一部の情報は、古いバージョンの Dispatcher に関するものです。
4. [Dispatcher の機能についての Gems ウェビナー、CDN 上の使用およびセキュリティ](https://docs.adobe.com/ddc/ja/gems/dispatcher-caching---new-features-and-optimizations.html)。
5. [Dispatcher の新しい機能に関する Gems セッション（v4.1.9 以降）](https://helpx.adobe.com/jp/experience-manager/kt/eseminars/gems/aem-dispatcher.html)。

<br><br><br><br><br><br>Dispatcher キャッシュの最適化<br><br><br><br><br><br>
次に、Dispatcher キャッシュを最適化する方法を示します。

1. <b>ほぼすべてをキャッシュする</b> - これは、ユーザーから 2 回以上リクエストされるようなコンテンツはすべてキャッシュすることを意味します。
2. <b>パーソナライズされたコンテンツを異なる期間でキャッシュする</b> - サイトにパーソナライズされたコンテンツがある場合、AEM アプリケーションで [[!DNL Apache Sling Dynamic Includes]](https://experienceleague.adobe.com/docs/experience-manager-learn/foundation/development/set-up-sling-dynamic-include.html?lang=ja) を使用して、[!DNL Ajax]（ブラウザーレベルでの非同期 JavaScript および XML 呼び出し）、SSI（web サーバーレベルでのサーバーサイドインクルード）、ESI（CDN レベルでのエッジサイドインクルード）を活用して、ページの異なる部分を異なる期間でキャッシュすることを考慮します。
3. <b>ライブ Dispatcher では決して Dispatcher キャッシュを削除しない</b> - Dispatcher がライブコンテンツを配信している場合にキャッシュを削除すると、大量のリクエストが AEM に戻されます。これにより、Dispatcher キャッシュはライブ Dispatcher では削除されません。
4. <b>キャッシュの準備</b> - [!DNL Dispatcher] キャッシュを削除する前に、[!DNL Dispatcher] をロードバランサーから引き出し、キャッシュを削除してから、ロードバランサーに配置する前に Dispatcher 上のファイルをキャッシュする web クローラーツールを実行します。
5. <b>エラーページをキャッシュする</b> - <b>[DispatcherPassError 1](https://helpx.adobe.com/jp/experience-manager/dispatcher/using/dispatcher-install.html#ApacheWebServer)</b>（[!DNL Apache] web サーバー専用の）ディレクティブを利用して、Dispatcher のキャッシュから 404 などのエラーページを提供します。
6. <b>事前に圧縮されているものを除き、すべてのファイルタイプを GZip で圧縮する</b> - [!DNL Apache] web サーバーでは、[mod_deflate](https://httpd.apache.org/docs/2.4/mod/mod_deflate.html) が使用できますが、<b>`Vary: User-Agent` </b>ヘッダー<b> </b>が設定されていないことを確認してください。Microsoft IIS では、[動的圧縮](https://docs.microsoft.com/ja-jp/iis/configuration/system.webserver/httpcompression/)を使用します。

   [!DNL Apache] 設定例（圧縮済みのファイルタイプを回避するために、特定のコンテンツタイプのみを指定）：

   `AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript`
7. <b> 設定で [/serveStaleOnError](https://helpx.adobe.com/jp/experience-manager/kb/ServeStaleContentOnError.html)</b> を有効にする`/cache` - AEM インスタンスでエラーを処理している際に、古いキャッシュファイルを提供します。
8.  <b>設定に [/gracePeriod](https://docs.adobe.com/content/help/ja/experience-manager-dispatcher/using/configuring/dispatcher-configuration.html#configuring-the-dispatcher-cache-cache)</b> を追加する`/cache` - 最後のコンテンツ公開イベント（「アクティブ化」）の後、自動で無効化された古いリソースがキャッシュから引き続き提供される秒数を定義します。これにより、「ツリーのアクティブ化」などの大規模なコンテンツ公開アクティビティの際にパブリッシュインスタンスに戻るリクエストの数が減ります。
9. <b>[/ignoreUrlParams](https://helpx.adobe.com/jp/experience-manager/dispatcher/using/dispatcher-configuration.html#IgnoringURLParameters) にルールを追加する</b> - アプリケーションが必要としない、または使用しないクエリ文字列パラメーターを無視します。これにより、クエリ文字列が存在する場合でも、URL のキャッシュが可能になります。
10. <b>Cache-Control および Last-Modified 応答ヘッダーをキャッシュする</b> - <b>[/headers](https://helpx.adobe.com/jp/experience-manager/dispatcher/using/dispatcher-configuration.html#CachingHTTPResponseHeaders)</b> 設定を使用して、HTTP 応答ヘッダーの <b>`Cache-Control`</b> および <b>`Last-Modified`</b>（および／または AEM から送信している場合は <b>`ETag`</b> ヘッダー）をキャッシュします。これは、CDN およびブラウザーレベルでキャッシュを簡素化し、最適化するのに役立ちます。これらのヘッダーをキャッシュすることで、web サーバー自体ではなく、AEM のみがヘッダーを設定するようになります。これを行う場合、AEM アプリケーションからヘッダーを送信し始める必要があることに注意してください。
11. <b>コンテンツをできるだけ長くキャッシュ</b>し、<b>AEM に戻るリクエストを減らす</b> - すべてのフラッシュエージェントでフラッシュの[再取得](https://helpx.adobe.com/experience-manager/kb/optimizing-the-dispatcher-cache.html#refetching-flush)を有効にして、フラッシュリクエストを最適化します。または、[<b>/enableTTL</b>](https://helpx.adobe.com/experience-manager/kb/optimizing-the-dispatcher-cache.html#use-ttls) を使用して <b>`Cache-Control: max-age=...`</b> ヘッダーを設定することで、可能な限り長くファイルをキャッシュします。このトピックについて詳しくは、[こちら](https://helpx.adobe.com/experience-manager/kb/optimizing-the-dispatcher-cache.html#use-ttls)を参照してください。

<br><br><br><br><br><br>TTL の使用<br><br><br><br><br><br>
現在の [!DNL Dispatcher] バージョン 4.1.11 では、`.any` ファイル設定で [/enableTTL 1](https://helpx.adobe.com/jp/experience-manager/dispatcher/using/dispatcher-configuration.html#ConfiguringTimeBasedCacheInvalidationenableTTL) を設定できます。この設定により、Dispatcher は HTTP `Cache-Control` 応答ヘッダーで設定されたキャッシュの有効期限を尊重するようになります。つまり、Dispatcher は、ファイルの有効期限が切れると、プライマリ形式のキャッシュ無効化が発生する CDN と同様に機能します。これを実装し、AEM からのすべての応答に <b>`Cache-Control: max-age=...` </b>を送信し始めると、パブリッシュインスタンスで Dispatcher フラッシュエージェントを安全に無効にできます。

パブリッシュインスタンスでフラッシュエージェントを無効にした後も、Dispatcher キャッシュをフラッシュできるようにすることができます。その場合、[ACS Commons - Dispatcher フラッシュ UI](https://adobe-consulting-services.github.io/acs-aem-commons/features/dispatcher-flush-ui/index.html) を使用することができます。このツールは、オーサーインスタンスにインストールされています。これは、ユーザーが手動でキャッシュのフラッシュリクエストを実行できる UI を提供します。

<b>I. TTL（「Time to Live」または有効期限）スタイルの無効化を有効にするための手順：</b>

1. AEM アプリケーションのソースコードを変更して、<b>`Cache-Control` </b>ヘッダーおよび <b>`Last-Modified` </b>がまだ設定されていないすべてのリクエストに対して送信するようにします。
2. [!DNL Dispatcher] 4.1.11 以降をインストールします。
3. サイトの `.any` ファーム設定で、<b>[/enableTTL 1](https://helpx.adobe.com/experience-manager/dispatcher/using/dispatcher-configuration.html#ConfiguringTimeBasedCacheInvalidationenableTTL)</b> を設定します。
4. <b>`Cache-Control`</b> および <b>`Last-Modified`</b> ヘッダーをキャッシュするように <b>[/headers](https://helpx.adobe.com/experience-manager/dispatcher/using/dispatcher-configuration.html#CachingHTTPResponseHeaders) </b>を設定します。
5. Web サーバーを再起動します。


<b>II. パブリッシュインスタンスで Dispatcher フラッシュエージェントを無効にする：</b>

Dispatcher は、`Cache-Control` ヘッダーを使用して、キャッシュファイルの無効化を制御するようになりました。そのため、パブリッシュインスタンスからフラッシュされる Dispatcher が必要なくなりました。

1. 各パブリッシュインスタンスの `/etc/replication/agents.publish.html` に移動します。
2. 各フラッシュエージェントの設定に移動して、エージェントを無効にします。


<b>III. オーサーインスタンスからの手動 Dispatcher フラッシュリクエストを許可する：</b>

フラッシュエージェントが無効になっているので、コンテンツが Dispatcher で更新される際に、完全に <b>`Cache-Control` </b>ヘッダーに依存します。それでも、次のように Dispatcher キャッシュを手動でフラッシュすることユーザーに許可できます。

1. [ACS Commons - Dispatcher フラッシュ UI](https://adobe-consulting-services.github.io/acs-aem-commons/features/dispatcher-flush-ui/index.html) をオーサーインスタンスにインストールします。
2. オーサーインスタンスでフラッシュエージェントを設定します。
3. 各エージェント設定で、<b>Triggers</b> = <b>Ignore Default</b> オプションを有効に設定します。このオプションは、ユーザーが AEM UI で<b>公開（非公開）</b>または<b>アクティブ化（非アクティブ化）</b>をクリックしたときに、フラッシュエージェントを無視するようにします。

<br><br><br><br><br><br>Dispatcher フラッシュの再取得<br><br><br><br><br><br>
Dispatcher フラッシュのリクエストを最適化するために、すべての Dispatcher フラッシュエージェントは、フラッシュの再取得という機能を有効にする必要があります。

Dispatcher フラッシュの再取得を有効にするには、次の手順を実行します。

1. <b>*http://aemhost:port*/crx/packmgr/index.jsp</b> に移動して、管理者としてログインします。
2. [こちら](https://github.com/cqsupport/webinar-dispatchercache/blob/master/packages/dispatcher-flush-refetch-samplecode-1.0.zip?raw=true)からパッケージをダウンロードします。
3. パッケージをパッケージマネージャーにアップロードしてインストールします。
4. Dispatcher フラッシュエージェント設定に移動します。例： <b>/etc/replication/agents.author/flush.html</b>
5. 「<b>[!UICONTROL 編集]</b>」をクリックします。
6. 次の内容を設定します。
   - <b>Serialization Type</b> = <b>Re-fetch Dispatcher Flush</b>
   - <b>Extended</b> = <b>HTTP Method</b> = <b>POST</b>
7. 「<b>[!UICONTROL Save]</b>」をクリックします


上記でインストールしたパッケージは、あくまで基本的な例であることに注意してください。フラッシュの再取得をカスタマイズおよび最適化するために、送信する URI のリストを変更できます。このコードはオープンソースで、[こちら](https://github.com/cqsupport/webinar-dispatchercache/tree/master/src/refetching-flush-agent/refetch-bundle)で見つけることができます。このコードは、どのバスを再取得したらよいか Dispatcher に示すパラメーターとして、リクエスト本文に URI のリストを追加します。サイトのキャッシュ機能を最適化するために、アプリケーションの要件に応じて、より多くのパスを追加できます。<br><br><br><br><br><br>フラッシュの再取得のより詳しい説明<br><br><br><br><br><br>
通常、Dispatcher フラッシュは、ファイルを削除することで動作します。

1. `.stat` ファイルにタッチします
2. `/content/foo.\*` を削除します
3. `/content/foo/_jcr_content` を削除します


手順 2 でファイルが削除されるので、次にユーザーが `/content/foo.html` や `/content/foo.json`などのファイルをリクエストすると、ファイルが「再フェッチ」されている間、同じファイルに対する後続のリクエストも、そのファイルがキャッシュされるまで、パブリッシュインスタンスに送信されることになります。応答が遅いページやホームページなどのトラフィックが多いページでは、これが、パブリッシュインスタンス層がフラッディングする原因となる可能性があります。

この問題を解決するには、「re-fetching」という名前の Dispatcher の機能を有効にします。この機能を使用すると、Dispatcher が削除する代わりに、事前に「re-fetch」して置き換える URI のリストを送信できます。

仕組みと設定方法のデモについては、この[プレゼンテーション](https://my.adobeconnect.com/p7th2gf8k43)の 22:41-27:05 を参照してください。
