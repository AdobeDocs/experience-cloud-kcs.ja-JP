---
title: 「AEM 6.x で SegmentNotFound 問題が報告された場合のリポジトリの不整合の修正」
description: 説明
solution: Experience Manager
product: Experience Manager
applies-to: "Experience Manager"
keywords: "KCS"
resolution: Resolution
internal-notes: "Helpx Link: https://helpx.adobe.com/experience-manager/kb/fix-inconsistencies-in-the-repository-when-segmentnotfound-issue.html"
bug: false
article-created-by: Emily Geary
article-created-date: "4/12/2021 6:11:55 PM"
article-published-by: Emily Geary
article-published-date: "4/12/2021 6:12:16 PM"
version-number: 6
article-number: KA-16542
dynamics-url: "https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=18318d8e-ba9b-eb11-b1ac-000d3a3680d8"
exl-id: b9b98c01-bc0b-4384-bc5d-67a6eb899ec4
source-git-commit: e8f4ca2dd578944d4fe399074fab461de88ad247
workflow-type: tm+mt
source-wordcount: '276'
ht-degree: 6%

---

# AEM 6.x で SegmentNotFound Issue が報告された場合のリポジトリでの不整合の修正

## 説明


ログで SegmentNotFound 例外が観察されました。 例：

1. \*ERROR\* FelixStartLevel org.apache.sling.event org.apache.sling.event.impl.jobs.queues.QueueManager(1431) activate メソッドが例外をスローしました (org.apache.jackrabbit.oak.plugins.segment.SegmentNotFoundException:セグメント da5bcb95-d00a-4c04-a9d9-0f10f2b14e5e が見つかりません )
2. \*ERROR\* pool-6-thread-3 org.apache.sling.commons.scheduler.impl.QuartzScheduler org.apache.jackrabbit.oak.plugins.index.AsyncIndexUpdate@1dc173f9のジョブ実行中に例外が発生しました。セグメント e669f30b-e886-4b7a-b161-56432601ec6b が見つかりません

   org.apache.jackrabbit.oak.plugins.segment.SegmentNotFoundException:セグメント e669f30b-e886-4b7a-b161-56432601ec6b が見つかりません


<b>環境</b>

AEM 6.\*

<b>原因</b>：

Oak の古い問題やリポジトリ内の不整合が原因で、セグメントが欠落し、リポジトリの不整合が生じる可能性があります。


## 解像度


リポジトリの整合性チェックを実行し、最後に正常なリビジョンの正常な状態を見つけて、その状態に戻します。 次の点に留意してください。

1. oak コアバージョンに一致する oak-run のバージョンをからダウンロードします。 [https://mvnrepository.com/artifact/org.apache.jackrabbit/oak-run](https://mvnrepository.com/artifact/org.apache.jackrabbit/oak-run)
2. 破損したセグメントストアを最新の適切な状態に戻すには、CQ の作業ディレクトリ（crx-quickstartfolder を含むディレクトリ）に変更し、内のすべてのファイルをバックアップします。/crx-quickstart/repository/segmentstore/に設定します。
3. 整合性チェックを実行します。

   <b>`java -Xmx6000m -jar oak-run-*.jar check --bin=-1 /path/to/crx-quickstart/repository/segmentstore`</b>



   これにより、リビジョンが一貫して見つかるまで、リビジョンを逆方向に検索します。



   以下のようなメッセージを探します。

   main INFO o.a.j.o.p.s.f.t.ConsistencyChecker — 最新の良いリビジョン afdb922d-ba53-4a1b-aa1b-1cb044b535cf:234880が見つかりました


4. を編集して、リポジトリをこのリビジョンに戻します。/crx-quickstart/repository/segmentstore/journal.logを参照し、最新の適切なリビジョンを含む行の後のすべての行を削除します。
5. すべてを削除します。/crx-quickstart/repository/segmentstore/\*.bak ファイル
6. 孤立したチェックポイントを削除するには、チェックポイントのクリーンアップを実行します。

   <b>`java -Xmx6000m -jar oak-run-*.jar checkpoints /path/to/crx-quickstart/repository/segmentstore rm-unreferenced`</b>


7. 最後に、リポジトリをコンパクトします。

   <b>`java -Xmx6000m -jar oak-run-*.jar compact /path/to/crx-quickstart/repository/segmentstore/`</b>&#x200B;&#x200B;&#x200B;&#x200B;&#x200B;&#x200B;&#x200B;T
