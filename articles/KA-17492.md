---
title: AEMインデックス作成の問題の分析
description: 説明
solution: Experience Manager
product: Experience Manager
applies-to: Experience Manager
keywords: KCS
resolution: Resolution
internal-notes: null
bug: false
article-created-by: Roxann McGlumphy
article-created-date: 10/21/2021 5:47:49 PM
article-published-by: Cedric Latimier
article-published-date: 1/6/2022 9:04:25 AM
version-number: 1
article-number: KA-17492
dynamics-url: https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=846ba2fc-9632-ec11-b6e5-000d3a5ba97a
exl-id: 59a10140-0386-42f8-bd1a-a934a2276ca5
source-git-commit: e8f4ca2dd578944d4fe399074fab461de88ad247
workflow-type: tm+mt
source-wordcount: '858'
ht-degree: 1%

---

# AEMインデックス作成の問題の分析

## 説明


この記事の目的は、一般的なインデックス作成の問題をすべてトラブルシューティングする方法の詳細を知ることです。


## 解像度

<br><br>処理に時間のかかるクエリの分析<br><br><br><br> <br><br>
ツール/操作/ダッシュボード/診断/クエリパフォーマンスに移動すると、処理に時間のかかるクエリのリストが表示されます。

詳しくは、 [このドキュメント](https://docs.adobe.com/docs/en/aem/6-2/deploy/platform/queries-and-indexing.html#Troubleshooting%20indexing%20issues) を参照してください。

非実稼動環境では、ACS AEMツールパッケージをインストールして、詳細なデバッグをおこなうためのクエリの説明を実行ツールを提供できます。
<br><br><br><br> <br><br>非同期インデックスの再インデックス<br><br><br><br><br><br>
注意：

インデックスの再作成では、通常、クエリに関する問題（クエリが正しい結果を返さないなど）は解決されません。 また、インデックス再作成には長い時間がかかる場合があります。インデックス再作成は、リストに記載されている理由の範囲を超えない限り、避ける必要があります。
<br><br><br><br> <br><br>
<b>非同期インデックスの再インデックスの方法</b>

- AEMインスタンスにログインします。
- http://aemhost:port/crx/de/index.jspを開きます。
- /oak:index の下のインデックス定義を参照します。
- インデックスを再インデックス化するブール型プロパティ reindex=true を設定し、保存します。 インデックス作成を開始すると、次のようなログメッセージが表示されます。


23.06.2015 14:26:23.070 \*INFO\* FelixStartLevel org.apache.jackrabbit.oak.plugins.index.IndexUpdate 次のインデックスに対してインデックス再作成が実行されます。/oak:index/cqAcUUID, /oak:index/nodetype, /oak:index/deviceIdentificationMode, /oak:index/campaignpath, /oak:index/active, /oak:index/jcrFrozenMixinTypes

- インデックス再作成中に、IndexStatsMBean の「status」属性に値「running」が設定されます。

 23.06.2015 14:26:23.517 \*INFO\* FelixStartLevel org.apache.jackrabbit.oak.plugins.index.IndexUpdate Reindexing Traversed #10000 /jcr:system/jcr:versionStorage/c8/5f...23.06.2015 14:28:51.999 \*INFO\* pool-8-thread-1 org.apache.jackrabbit.oak.plugins.index.IndexUpdate インデックス作成レポート — /oak:index/counter\*(708) - /oak:index/authorizables\*(159) - /oak:index/cqPageLucene\*(19913) - /oak:index/ntBaseLucene\*(444) - /oak:index/cqTagLucene\*(512) - /oak:index/workflowDataLucene\*(116)
- インデックス定義ノードを確認し、reindexCount プロパティを増分し、reindex ブール値を「false」に設定して、インデックスが完了したことを確認できます。

   ログファイルで、インデックス作成が正常に完了した場合は、次のエントリが表示されます

23.06.2015 14:28:52.009 \*INFO\* pool-8-thread-1 org.apache.jackrabbit.oak.plugins.index.AsyncIndexUpdate インデックスの再インデックス（非同期）が完了しました：/oak:index/counter\*(708), /oak:index/authorizables\*(159), /oak:index/cqPageLucene\*(1913), /oak:index/ntBaseLucene\*(444), /oak:index/cqTagLucene\*512)、30.36 s で/oak:index/workflowDataLucene\*(116)
- インデックス再作成が完了せず、ループに陥った場合は、 [以下の節](https://helpx.adobe.com/experience-manager/kb/Analyzing-AEM-Indexing-Issues.html#Analyzing_Failed_Reindexing).


非同期インデックスアクティビティは、org.apache.jackrabbit.plugins.index.IndexUpdate および org.apache.jackrabbit.plugins.index.AsyncIndexUpdate に対してグリップすることで、INFO レベルで識別できます。
 <br><br>非同期インデックス作成のパフォーマンスの問題<br><br><br><br> 
- ログを有効にしてタイミングを検証：


TRACEレベル（Oak 1.0.17 以降のみ）:

org.apache.jackrabbit.oak.plugins.index.lucene.LuceneIndexEditorContext.perf

デバッグレベル：

org.apache.jackrabbit.oak.plugins.index.AsyncIndexUpdate

org.apache.jackrabbit.oak.plugins.index.IndexUpdate

org.apache.jackrabbit.oak.plugins.index.lucene.LuceneIndexEditor

org.apache.jackrabbit.oak.plugins.index.lucene.IndexTracker

org.apache.jackrabbit.oak.plugins.index.lucene.LuceneIndexEditorContext

org.apache.jackrabbit.oak.plugins.index.lucene.IndexCopier

次のようなログが、インデックス作成のタイミングを示して生成されます。

09.07.2015 08:13:38.401 \*TRACE\* 192.168.193.1 1436444018387POST/content/dam/site/test.createasset.html HTTP/1.1 org.apache.jackrabbit.oak.jcr.operations.writes session-101777ノードの追加/content/dam/site/test/jackrabbit-oak7.png 09.07.2015 08:13:38.583 \*TRACE\* 192.168.193.1 1436444018387POST/content/dam/site/test.createasset.html HTTP/1.1 org.apache.jackrabbit.oak.jcr.operations.writes session-101777 save 09.07.2015 08:13:42.823 \*DEBUG\* pool-9-thread-1 org.apache.jackrabbit.oak.plugins.index.AsyncIndexUpdate 実行中のバックグラウンドインデックスタスク async 09.07.2015 08:13:42.963 \*TRACE\* pool-9-thread-1 org.apache.jackrabbit.oak.plugins.index.lucene.LuceneIndexEditor /oak:index/lucene /content/dam/site/test/jackrabbit-oak7.png/jcr:content/related のインデックス付きドキュメントは Documentstored,indexed,omms,indexOptions=DOCS_ONLY です:path:/content/dam/site/test/jackrabbit-oak7.png/jcr:content/related indexed,tokenized:fulltext:関連09.07.2015 08:13:43.579 \*DEBUG\* pool-9-thread-1 org.apache.jackrabbit.oak.plugins.index.IndexUpdate インデックス作成レポート
- /oak:index/siteDamIndex(2)
- /oak:index/lucene(15)

09.07.2015 08:13:43.779 \*TRACE\* oak-lucene-0 org.apache.jackrabbit.oak.plugins.index.lucene.IndexTracker.perf /oak:index/siteDamIndex Index が更新されています。 IndexNode を再度開くのに、150 ms 09.07.2015 08 時間かかりました:13:45.248 \*TRACE\* oak-lucene-0 org.apache.jackrabbit.oak.plugins.index.lucene.IndexCopier.perf /oak:index/lucene コピーされた 0 個のファイルの合計は 1465ms 09.07.2015 08:13:45.248 \*TRACE\* oak-lucene-0 org.apache.jackrabbit.oak.plugins.index.lucene.IndexCopier /oak:index/lucene リモートのみのファイル segments.gen 09.07.2015 08:13:45.361 \*TRACE\* oak-lucene-0 org.apache.jackrabbit.oak.plugins.index.lucene.IndexTracker.perf /oak:index/lucene Index が更新されています。 IndexNode を再度開くのに、1581 ミリ秒かかりました

- 一連のスレッドダンプを取り、スタック内の AsyncIndexUpdate を含むスレッドを検索して、インデックス作成に要する時間の大部分がどこに費やされているか、またはインデックス作成が他のスレッドで待機しているかを確認します。 スレッドダンプを取得するには、を参照してください。 [この記事](https://helpx.adobe.com/jp/experience-manager/kb/TakeThreadDump.html).
- ブール型のプロパティ saveDirectoryListing=true を設定し（Oak 1.0.16 を使用し、後のバージョンが必要でない場合のみ）、プロパティ excludedPaths=/var、/etc/workflow/instances、/jcr:system を/oak:index/lucene OOTB インデックスに設定して最適化します。
- 「すべて保存」をクリックします。
- Oak 1.0.16 を使用し、 includedPaths (String) プロパティを設定して、特定のパスのみにインデックスを作成するようにインデックスを制限する場合は、カスタム lucene プロパティインデックスを作成する際は、saveDirectoryListing=true (Boolean) を必ず設定します。


この URL /system/console/configMgr/org.apache.jackrabbit.oak.plugins.index.lucene.LuceneIndexProviderService &quot;Copy on Read&quot;, &quot;Copy on Write&quot; （Oak 1.0.18 以降でのみ安全に使用できます）と&quot;Prefetch Index Files&quot; （Oak 1.0.18 以降のみ）に移動します。
<br><br><br>再インデックス失敗の分析<br><br><br><br>
- 非同期インデックス作成が失敗した場合、 Async Indexer stats JMX UI （以下のリンク）をチェックすると、 LastIndexedTime が古い日時であることがわかります。


http://localhost:4502/system/console/jmx/org.apache.jackrabbit.oak%3Aid%3D11%2Cname%3D&quot;async&quot;%2Ctype%3D&quot;IndexStats&quot;

- また、インデックス再作成が失敗すると、次のようなループに陥ります。


08.01.2015 01:22:04.474 \*INFO\* pool-9-thread-2 org.apache.jackrabbit.oak.plugins.index.IndexUpdate 次のインデックスに対してインデックス再作成が実行されます/oak:index/damFileSize, /oak:index/lucene, /oak:index/cqLastModified08.01.201501:52:08.365 \*INFO\* pool-9-thread-5 org.apache.jackrabbit.oak.plugins.index.IndexUpdate 次のインデックスに対してインデックス再作成が実行されます/oak:index/damFileSize, /oak:index/lucene, /oak:index/cqLastModified08.01.201509:33:23.306 \*INFO\* pool-9-thread-5 org.apache.jackrabbit.oak.plugins.index.IndexUpdate 次のインデックスに対してインデックス再作成が実行されます/oak:index/damFileSize, /oak:index/lucene, /oak:index/cqLastModified

- その場合は、org.apache.jackrabbit.oak.plugins.index のデバッグレベルのログを有効にする必要があります


- 次にインデックス作成がデバッグログメッセージの上のログメッセージでループする場合、インデックス作成が失敗した理由に関する詳細が表示されます。  次に、問題に対処できます。問題が壊れたノードであるか、BLOB が見つからないか、その他の問題です。
