---
title: oak-run を使用してデータストアの整合性チェックを実行する方法
description: 説明
solution: Experience Manager
product: Experience Manager
applies-to: Experience Manager
keywords: KCS
resolution: Resolution
internal-notes: null
bug: false
article-created-by: Akash Kapoor
article-created-date: 4/3/2022 9:37:38 PM
article-published-by: Akash Kapoor
article-published-date: 4/3/2022 9:39:46 PM
version-number: 2
article-number: KA-19064
dynamics-url: https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=68a58547-96b3-ec11-983f-000d3a5d09d6
exl-id: 8aec0830-a1db-4e57-95e4-3745e87bde32
source-git-commit: e8f4ca2dd578944d4fe399074fab461de88ad247
workflow-type: tm+mt
source-wordcount: '392'
ht-degree: 6%

---

# oak-run を使用してデータストアの整合性チェックを実行する方法

## 説明

データストアの整合性チェックは、見つからないが引き続き参照されているデータストアのバイナリを報告します。 整合性チェックは、Felix コンソールで直接トリガーできます。<br>
MarkSweepGarbageCollector#checkConsistency Mbean からトリガーされる可能性があります

BlobGC MBean が MBeanServer に登録されている場合は、次の mbean も使用できます。

BlobGCMbean#checkConsistency

整合性チェックが完了すると、メッセージに欠落として報告されるバイナリの数が表示されます。0 より大きい数の場合、org.apache.jackrabbit.oak.plugins.blob .MarkSweepGarbageCollector 用に設定されたログを調べて、見つからないバイナリの詳細を確認してください。

不足しているバイナリがログにどのように報告されるかの例を次に示します。

`11:32:39.673 INFO main MarkSweepGarbageCollector.java:600 Consistency check found 1 missing blobs 11:32:39.673 WARN main MarkSweepGarbageCollector.java:602 Consistency check failure in the the blob store : DataStore backed BlobStore org.apache.jackrabbit.oak.plugins.blob.datastore.OakFileDataStore, check missing candidates in file /tmp/gcworkdir-1467352959243/gccand-1467352959243`

/system/console/repositorycheck UI とは異なり、oak-run ツールは/oak の下にある非表示の Lucene インデックスファイルをチェックします。インデックスを追加します。 「datastorecheck」コマンド <b>oak-run </b>を使用して、データストアで整合性チェックを実行できます。  コマンドの実行方法に関する詳細な手順を次に示します。




## 解像度


1. oak-run jar 1.8.8 以降のバージョンをAEMサーバーにダウンロードします。
2. crx-quickstart が配置されている同じディレクトリに oak run jar を配置します。それ以外の場合は、下のコマンドを実行しながら oak-run-\*.jar の完全なパスを指定します。
3. 次のコマンドを実行します（環境に従って、segmentstore と datastore のパスを更新します）。


`java -jar oak-run-*.jar datastorecheck --consistency --ref --id --fds crx-quickstart/install/org.apache.jackrabbit.oak.plugins.blob.datastore.FileDataStore.config --repoHome crx-quickstart/repository --store crx-quickstart/repository/segmentstore --dump temp --verbose --track`

4. このコマンドは、データストアの整合性チェックを出力します。

DataStore の整合性チェッカーは、ノードストア内のすべての BLOB 参照と、データストアで使用可能なすべての BLOB ID をリストするためにも使用できます。 次のコマンドを使用します。

`$ java-jar oak-run-*.jar datastorecheck --id --ref --consistency \`

`--store | \`

`--s3ds |--fds \`

`--dump \`

`--track`



次の使用可能なオプションを 1 つ以上指定します。

—id — データストア内のすべての id をリストします。

—ref — ノードストア内のすべての blob 参照をリストします。

—consistency — 整合性チェックを実行して、見つからない BLOB をすべてリストします。



次のオプションはオプションです。

—store - mongo uri のセグメントストアのパス（上記の —ref および —consistency オプションで必須）。

—dump — ファイルのダンプ先のパス（オプション）。 それ以外の場合、ファイルは user tmp ディレクトリにダンプされます。

—s3ds - S3DataStore 設定ファイルのパス。

—fds - FileDataStore 設定ファイルのパス（「path」プロパティは必須）。

—track — ローカルリポジトリのホームフォルダーのパス（オプション）。 ダウンロードした BLOB ID のコピーが追跡対象として配置されます。
