---
title: "SegmentNotFoundException と IllegalArgumentException"
description: 説明
solution: Experience Manager
product: Experience Manager
applies-to: "Experience Manager"
keywords: "KCS"
resolution: Resolution
internal-notes: "Helpx Link: https://helpx.adobe.com/experience-manager/kb/offline-compaction-fails-with-SegmentNotFoundException-and-IllegalArgumentException.html"
bug: false
article-created-by: Emily Geary
article-created-date: "4/12/2021 6:09:12 PM"
article-published-by: Emily Geary
article-published-date: "4/12/2021 6:09:50 PM"
version-number: 7
article-number: KA-16457
dynamics-url: "https://adobe-ent.crm.dynamics.com/main.aspx?forceUCI=1&pagetype=entityrecord&etn=knowledgearticle&id=7ed24a2d-ba9b-eb11-b1ac-000d3a3680d8"
exl-id: 54f6bac4-f81b-4685-89e6-eaedf60f3552
source-git-commit: e8f4ca2dd578944d4fe399074fab461de88ad247
workflow-type: tm+mt
source-wordcount: '956'
ht-degree: 0%

---

# SegmentNotFoundException および IllegalArgumentException

## 説明


リポジトリの整合性に問題がある場合、オフライン圧縮の実行は SegmentNotFoundException で失敗する可能性があります。

AEMログファイルに SegmentNotFoundException が見つかり、AEMが期待どおりに動作しません

OR

リポジトリの整合性に問題がある場合、オフライン圧縮の実行は SegmentNotFoundException で失敗する可能性があります。 以下に示すようなスタックトレースは、ログに記録されています。

`13:51:21.523 main ERROR o.a.j.o.p.segment.SegmentTracker - Segment not found: 4d139bc4-150c-4f0a-b82a-40a4e519fe8a. Creation ` `date` `delta is 4 ms.`

`org.apache.jackrabbit.oak.plugins.segment.SegmentNotFoundException: Segment 4d139bc4-150c-4f0a-b82a-40a4e519fe8a not found`

`at org.apache.jackrabbit.oak.plugins.segment.` `file` `.FileStore.readSegment(FileStore.java:855) oak-run-1.0.22.jar:1.0.22`

`at org.apache.jackrabbit.oak.plugins.segment.SegmentTracker.getSegment(SegmentTracker.java:134)  oak-run-1.0.22.jar:1.0.22`

`at org.apache.jackrabbit.oak.plugins.segment.SegmentId.getSegment(SegmentId.java:101) oak-run-1.0.22.jar:1.0.22`

`...`

`Exception ` `in` `thread ` `"main"` `org.apache.jackrabbit.oak.plugins.segment.SegmentNotFoundException: Segment 4d139bc4-150c-4f0a-b82a-40a4e519fe8a not found`

`at org.apache.jackrabbit.oak.plugins.segment.` `file` `.FileStore.readSegment(FileStore.java:855)`

`at org.apache.jackrabbit.oak.plugins.segment.SegmentTracker.getSegment(SegmentTracker.java:134)`

`at org.apache.jackrabbit.oak.plugins.segment.SegmentId.getSegment(SegmentId.java:101)`

`...`

または

リポジトリの整合性に問題がある場合、オフライン圧縮の実行は IllegalArgument 例外で失敗する可能性があります。 以下に示すようなスタックトレースは、ログに記録されています。


| `java.lang.IllegalArgumentException`<br><br>`at com.google.common.base.Preconditions.checkArgument(Preconditions.java:77)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.ListRecord.(ListRecord.java:41)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.ListRecord.getEntry(ListRecord.java:64)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.ListRecord.getEntries(ListRecord.java:81)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.SegmentStream.` `read` `(SegmentStream.java:153)`<br><br>`at org.apache.jackrabbit.oak.commons.IOUtils.readFully(IOUtils.java:53)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.Compactor.getBlobKey(Compactor.java:412)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.Compactor.compact(Compactor.java:362)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.Compactor.compact(Compactor.java:321)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.Compactor.access$500(Compactor.java:54)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.Compactor$CompactDiff.propertyAdded(Compactor.java:227)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.CancelableDiff.propertyAdded(CancelableDiff.java:47)`<br><br>`at org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.compareAgainstEmptyState(EmptyNodeState.java:156)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:434)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.Compactor$CompactDiff.` `diff` `(Compactor.java:214)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.Compactor$CompactDiff.childNodeAdded(Compactor.java:263)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.CancelableDiff.childNodeAdded(CancelableDiff.java:74)`<br><br>`at org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.compareAgainstEmptyState(EmptyNodeState.java:161)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:434)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.Compactor$CompactDiff.` `diff` `(Compactor.java:214)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.Compactor$CompactDiff.childNodeAdded(Compactor.java:263)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.CancelableDiff.childNodeAdded(CancelableDiff.java:74)`<br><br>`at org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.compareAgainstEmptyState(EmptyNodeState.java:161)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:434)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.Compactor$CompactDiff.` `diff` `(Compactor.java:214)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.Compactor$CompactDiff.childNodeAdded(Compactor.java:263)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.CancelableDiff.childNodeAdded(CancelableDiff.java:74)`<br><br>`at org.apache.jackrabbit.oak.plugins.memory.EmptyNodeState.compareAgainstEmptyState(EmptyNodeState.java:161)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.SegmentNodeState.compareAgainstBaseState(SegmentNodeState.java:434)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.Compactor$CompactDiff.` `diff` `(Compactor.java:214)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.Compactor$CompactDiff.childNodeAdded(Compactor.java:263)`<br><br>`at org.apache.jackrabbit.oak.plugins.segment.CancelableDiff.childNodeAdded(CancelableDiff.java:74)` |
| --- |


<b>原因</b>：

圧縮がノードの読み取りを試行している間にセグメントが存在しない場合は、SegmentNotFoundException が返されます。 これには、様々な根本原因が考えられます。

1. セグメントは、手動の介入（例：rm -rf /）によって削除されました。
2. セグメントは、リビジョンのガベージコレクションによって削除されました。
3. コードにバグがあるので、セグメントが見つかりません。


リビジョンのガベージコレクション（ポイント 2）が原因で問題が発生した場合は、それ以上のノードが破損するのを防ぐために、オンラインコンパクションを無効にしてください。


## 解像度


状況を解決し、オフライン圧縮を正常に完了するために従う手順は複数あります。

*重要：* 次の手順に従う前に、リポジトリの完全バックアップを実行します。



<b>A.セグメントストアの正常な最新のリビジョンに戻します。</b>

oak-run のチェック実行モードを使用して、セグメントストアの最新の正常なリビジョンを判断できます。 これを使用して、破損したセグメントストアを最新の適切なリビジョンに手動で戻すことができます。

*注意：<b>* </b>このプロセスは、システム内のデータを以前の時点にロールバックします。  システムの変更が失われないようにしたい場合は、代わりに以下のオプション B を試してみてください。

チェックと復元を実行するには、次の手順に従います。

1. oak-run jar ファイルをこちらからダウンロードします。 [http://repo1.maven.org/maven2/org/apache/jackrabbit/oak-run/](http://repo1.maven.org/maven2/org/apache/jackrabbit/oak-run/)
2. AEMを停止します。
3. 次のコマンドを実行します。

   `java -jar oak-run-*.jar check --bin=-1 crx-quickstart/repository/segmentstore/`



   このコマンドは、リビジョンが一貫して見つかるまで、リビジョンを逆方向に検索します。

   `14:00:30.783 main INFO  o.a.j.o.p.s.f.t.ConsistencyChecker - Found latest good revision afdb922d-ba53-4a1b-aa1b-1cb044b535cf:234880`



   （ConsistencyChecker が失敗した場合は、次のセクションに進みます）。


4. リポジトリを編集してこのリビジョンに戻します。

   `/crx-quickstart/repository/segmentstore/journal.log.`



   最新の適切なリビジョンを含む行の後の行をすべて削除します。 リポジトリを元に戻す日時を確認する場合は、segmentstore フォルダーで次のコマンドを実行します（afdb922d-ba53-4a1b-aa1b-1cb044b535cf を journal.log 内の最新の適切なリビジョンに置き換えます）。

   `find . -type f -name "data*.tar" -exec sh -c "tar -tvf {} |grep afdb922d-ba53-4a1b-aa1b-1cb044b535cf" \; -print`



   この出力には、そのリビジョンのおおよその日時が表示されます。


5. すべてを削除 `./crx-quickstart/repository/segmentstore/*.bak files.`
6. AEM 6.0 を使用している場合は、残りの手順で、AEMにインストールされているものと一致する oak-run バージョンをダウンロードします。  こちらからダウンロード [http://repo1.maven.org/maven2/org/apache/jackrabbit/oak-run/](http://repo1.maven.org/maven2/org/apache/jackrabbit/oak-run/).
7. 孤立したチェックポイントを削除するには、チェックポイントのクリーンアップを実行します。

   `java -jar oak-run-*.jar checkpoints ./crx-quickstart/repository/segmentstore rm-unreferenced.`


8. 最後に、リポジトリをコンパクトします。

   `java -jar oak-run-*.jar compact ./crx-quickstart/repository/segmentstore/`




<b>B.破損したノードを手動で削除します。</b>

FileDatastore が設定されていないAEM、TarMK 設定およびバイナリで破損が発生する状況では、次の操作を実行できます。

注意：以下の手順は、パワーユーザー向けです。  破損したノードを削除する場合は、それらがシステムノード（ /home、/jcr:system など）でないことを確認する必要があります。  また、システムノードの場合は、復元できることを確認する必要があります。  不明な場合は、こちらに記載されている手順について、AEMカスタマーケアチームにお問い合わせください。

1. AEMを停止します。
2. Oak 実行コンソールを使用し、 childCount groovy スクリプトを読み込んで、セグメントストア内の破損したノードを識別します。

   oak-run コンソールシェルを読み込みます。

   `java -jar oak-run-*.jar console crx-quickstart/repository/segmentstore`



   シェルで次の 2 つのコマンドを実行してスクリプトを読み込み、実行します。

   `:load`

   `https://gist.githubusercontent.com/stillalex/e7067bcb86c89bef66c8/raw/d7a5a9b839c3bb0ae5840252022f871fd38374d3/childCount.groovy`

   `countNodes(session.workingNode)`



   これにより、次の出力が破損したノードへのパスを示します。

   `21:21:42.029 main ERROR o.a.j.o.p.segment.SegmentTracker - Segment not found: 63ae05a4-b506-445c-baa2-cfa1b13b6e2f. Creation date delta is 3 ms.`

   `warning unable to read node /content/dam/test.txt/jcr:content/renditions/original/jcr:content`



   場合によっては、問題がバイナリプロパティに関連しており、 childCount groovy スクリプトが破損したノードを見つけられないことがあります。  この場合、次のコマンドを使用すると、トラバーサル中に発生したすべてのバイナリの最初の 1024 バイトを読み取ることができます（このコマンドは低速になり、上記のコマンドが期待された結果を返さない場合にのみ使用します）。

   `countNodes(session.workingNode,true)`


3. rmNodes.groovy を使用して、最後のコマンドの出力にリストされている、識別された破損したノードをすべて削除します。

   oak-run コンソールシェルを読み込みます。

   `java -jar oak-run-*.jar console crx-quickstart/repository/segmentstore`



   groovy スクリプトを読み込みます。

   `:load`

   `https://gist.githubusercontent.com/stillalex/43c49af065e3dd1fd5bf/raw/9e726a59f75b46e7b474f7ac763b0888d5a3f0c3/rmNode.groovy`



   rmNode コマンドを実行して、破損したノードを削除し、 /path/to/corrupt/node を、削除する破損したノードのパスに置き換えます。

   `rmNode(session, "/path/to/corrupt/node")`



   破損したノードのパスは、手順 2 で取得したパスです。次に例を示します。 `"/content/dam/test.txt/jcr:content/renditions/original/jcr:content/"`
注意：oak-run.jar バージョン 1.6.13 以降を使用する場合、次のようなエラーが発生した場合は、—read-write JVM パラメータを設定します。






   ```
   / rmNode(session,"/path/to/corrupt/node")    Removing node /path/to/corrupt/node    ERROR java.lang.UnsupportedOperationException:    Cannot write to read-only store    at org.apache.jackrabbit.oak.segment.SegmentWriterBuilder$1.execute (SegmentWriterBuilder.java:171)    at org.apache.jackrabbit.oak.segment.SegmentWriter.writeNode (SegmentWriter.java:318)    at org.apache.jackrabbit.oak.segment.SegmentNodeBuilder.getNodeState (SegmentNodeBuilder.java:111)    at org.apache.jackrabbit.oak.segment.SegmentNodeStore$Commit.init (SegmentNodeStore.java:581)    at org.apache.jackrabbit.oak.segment.SegmentNodeStore.merge (SegmentNodeStore.java:333)    at org.apache.jackrabbit.oak.spi.state.NodeStore$merge.call (Unknown Source)    at groovysh_evaluate.rmNode (groovysh_evaluate:11)
   ```

4. 手順 2 で見つかったすべてのノードに対して、手順 3 を繰り返します。

   この rmNode コマンドは、破損したパスに対して true を返す必要があります。つまり、パスが削除されました。 これらのパスで rmNode コマンドを再実行して、3 つの破損したパスが削除されることを確認します。 次に実行すると、false が返されます。

   それでもリポジトリ内に同じパスが存在する場合は、パッチを適用したバージョンの oak-run jar(oak-run-1.2.18-NPR-17596) を使用します。

   パッチが適用されたバージョンの Oak run Jar では何をしますか？

   このバージョンの jar は、圧縮時に読み取り不能なバイナリをスキップし、0 バイトのバイナリに置き換え、例外と syser へのパスをログに記録します。 このように圧縮されたリポジトリは、oak-run チェック、ノード数スクリプトを渡し、パッチが適用されていない oak-run を使用して再びコンパクト化できるはずです。


5. 以下を使用してチェックポイントをリストし、チェックポイントのクリーンアップを実行します。 複数のチェックポイントがある場合は、次の手順でクリーンアップします。

   `nohup java -Xmx4096m -jar oak-run-1.2.18.jar checkpoints /app/AEM6/author/crx-quickstart/repository/segmentstore rm-allnohup.out &`
6. オフライン圧縮を実行します。  オフライン圧縮の実行方法がわからない場合は、 [ここ](https://gist.github.com/andrewmkhoury/0b1fe4d8b619178ff87b).
7. サーバーを起動し、インデックス作成が完了するまで待ちます。
